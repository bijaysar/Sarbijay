
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gaming Tournament</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- CSS Styles (No changes needed here) --- */
        :root {
            --primary-bg: #0F172A;
            /* Dark blue-gray */
            --secondary-bg: #1E293B;
            /* Slightly lighter blue-gray */
            --card-bg: #1E293B;
            --text-primary: #E2E8F0;
            /* Light gray for primary text */
            --text-secondary: #94A3B8;
            /* Muted gray for secondary text */
            --accent-color: #FACC15;
            /* Yellow accent */
            --accent-gradient: linear-gradient(to right, #FACC15, #FBBF24);
            --primary-button-bg: #3B82F6;
            /* Blue for primary actions */
            --border-color: #334155;
            /* Border color */
            --bottom-nav-bg: #1E293B;
            --success-color: #10B981;
            /* Green for success */
            --danger-color: #EF4444;
            /* Red for danger/errors */
            --warning-color: #F59E0B;
            /* Orange for warnings */
            --info-color: #3B82F6;
            /* Blue for info */
        }

        /* ... (Rest of the CSS styles remain exactly the same) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            /* Adjusted padding-top to account for header at top */
            padding-top: 60px;
            padding-bottom: 75px;
            min-height: 100vh;
            overflow-x: hidden;
            /* Prevent horizontal scroll */
            overscroll-behavior-y: contain;
        }

        a {
            color: var(--accent-color);
            text-decoration: none;
        }

        a:hover {
            color: #FBBF24;
        }

        .main-content {
            padding: 15px;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .custom-card {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .btn-custom {
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px 15px;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: background-color 0.2s ease, filter 0.2s ease;
        }

        .btn-custom-primary {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
        }

        .btn-custom-primary:hover {
            background-color: #2563EB;
        }

        .btn-custom-secondary {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-custom-secondary:hover {
            background-color: #334155;
        }

        .btn-custom-accent {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
        }

        .btn-custom-accent:hover {
            filter: brightness(1.1);
        }

        .btn-custom-link {
            background: none;
            border: none;
            color: var(--primary-button-bg);
            font-size: 0.9rem;
            font-weight: 500;
            padding: 0;
            cursor: pointer;
        }

        .text-accent {
            color: var(--accent-color);
        }

        .text-success {
            color: var(--success-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .form-control {
            background-color: var(--primary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 6px;
        }

        .form-control:focus {
            background-color: var(--primary-bg);
            border-color: var(--accent-color);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(250, 204, 21, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .form-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .alert {
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .list-group-item {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: none;
            border-bottom: 1px solid var(--border-color);
            padding: 15px;
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
        }

        .list-group-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .list-group-item:last-child {
            border-bottom: none;
        }

        .list-group-item i:first-child {
            color: var(--accent-color);
            margin-right: 15px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
        }

        .list-group-item .bi-chevron-right {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        #globalLoaderEl {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .spinner-border {
            color: var(--accent-color);
            width: 3rem;
            height: 3rem;
        }

        .placeholder-glow .placeholder {
            background-color: rgba(51, 65, 85, 0.5);
            animation: placeholder-glow 2s ease-in-out infinite;
        }

        .placeholder {
            background-color: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
        }

        @keyframes placeholder-glow {
            0% {
                background-color: rgba(51, 65, 85, 0.5);
            }

            50% {
                background-color: rgba(51, 65, 85, 0.7);
            }

            100% {
                background-color: rgba(51, 65, 85, 0.5);
            }
        }

        .interactive-list-item {
            cursor: pointer;
        }

        .referral-code {
            font-family: monospace;
            letter-spacing: 1px;
            user-select: all;
        }

        .app-header {
            position: fixed;
            top: 0;
            /* Changed to top */
            left: 0;
            width: 100%;
            height: 60px;
            background-color: var(--secondary-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 1;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            object-fit: cover;
            border: 1px solid var(--accent-color);
        }

        .header-title {
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .header-title span {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: block;
        }

        .header-back-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            margin-right: 5px;
            display: none;
            padding: 5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 1;
        }

        .notification-icon {
            font-size: 1.3rem;
            color: var(--text-primary);
            position: relative;
            background: none;
            border: none;
            padding: 0;
        }

        .notification-badge {
            position: absolute;
            top: -3px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            font-size: 0.6rem;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .wallet-chip {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            padding: 5px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 700;
            border: none;
            box-shadow: 0 1px 3px (0, 0, 0, 0.2);
            cursor: pointer;
        }

        .wallet-chip i {
            margin-right: 5px;
            font-size: 0.9rem;
        }

        .header-game-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 10px;
            display: none;
        }

        /* NEW CSS FOR TIME AND GREETING */
        .header-time-greeting {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
            text-align: center;
            flex-grow: 1;
            /* Allows it to take available space */
            margin: 0 10px;
            /* Add some margin */
            white-space: nowrap;
            /* Prevent wrapping */
            overflow: hidden;
            /* Hide overflow */
            text-overflow: ellipsis;
            /* Add ellipsis for overflow */
        }

        /* NEW CSS for Create Room Button in Header */
        .header-create-room-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            margin-left: 10px;
            padding: 5px;
            display: none;
            /* Hidden by default */
        }

        /* Highlight for create room button */
        .header-create-room-button.highlight {
            color: var(--accent-color);
            filter: brightness(1.2);
            transform: scale(1.1);
            transition: all 0.2s ease-in-out;
        }


        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 65px;
            background-color: var(--bottom-nav-bg);
            display: flex;
            /* Changed to center */
            justify-content: space-around;
            /* Changed to space-around for balancing */
            align-items: stretch;
            box-shadow: 0 -2px 5px (0, 0, 0, 0.2);
            z-index: 1000;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            /* Adjusted flex-grow for centering */
            flex-grow: 1;
            /* Keep flex-grow for even distribution */
            padding: 8px 0;
            transition: color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.7rem;
            /* Added margin for spacing when centered */
            margin: 0;
        }

        .nav-item i {
            font-size: 1.4rem;
            margin-bottom: 4px;
            line-height: 1;
        }

        .nav-item span {
            font-size: 0.7rem;
            font-weight: 500;
            line-height: 1;
        }

        .nav-item.active {
            color: var(--accent-color);
            background-color: rgba(250, 204, 21, 0.1);
            box-shadow: 0 0 10px rgba(250, 204, 21, 0.3);
            transform: translateY(-2px);
        }

        .swiper-container#promotionSliderEl {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            margin-bottom: 25px;
            --swiper-pagination-color: var(--accent-color);
            --swiper-pagination-bullet-inactive-color: var(--text-secondary);
            --swiper-pagination-bullet-size: 8px;
        }

        .swiper-slide {
            background-color: var(--secondary-bg);
            border-radius: 10px;
        }

        .swiper-slide img {
            display: block;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }

        .game-card {
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            padding: 0;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .game-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px (0, 0, 0, 0.2);
        }

        .game-card img {
            width: 100%;
            height: 130px;
            object-fit: cover;
            display: block;
        }

        .game-card span {
            display: block;
            padding: 10px 5px;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .tournament-tabs {
            display: flex;
            justify-content: space-around;
            background-color: var(--secondary-bg);
            padding: 5px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .tab-item {
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 8px 10px;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 6px;
            flex-grow: 1;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .tab-item.active {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
        }

        .tab-item i {
            margin-right: 5px;
        }

        .tournament-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .tournament-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }

        .tournament-card-tags span {
            background-color: var(--primary-bg);
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 500;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid var(--border-color);
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .tournament-card-timer {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .tournament-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
        }

        .tournament-card-title i {
            color: var(--accent-color);
        }

        .tournament-card-info {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            border-top: 1px dashed var(--border-color);
            border-bottom: 1px dashed var(--border-color);
            padding: 10px 0;
            margin: 10px 0;
            font-size: 0.8rem;
        }

        .info-item {
            text-align: center;
            flex: 1;
            padding: 0 5px;
        }

        .info-item span {
            display: block;
            color: var(--text-secondary);
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .info-item strong {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .info-item .prize-icon {
            color: var(--accent-color);
            font-size: 1.2rem;
        }

        .tournament-card-spots {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .tournament-card-spots span {
            font-weight: 600;
        }

        .progress {
            height: 6px;
            background-color: var(--primary-bg);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar {
            background-color: var(--warning-color);
            transition: width 0.3s ease;
        }

        .tournament-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .tournament-card-actions .btn-sm {
            padding: 8px 10px;
            font-size: 0.85rem;
            width: 100%;
        }

        .tournament-card-actions .btn-join {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            font-weight: 600;
            grid-column: 2 / 3;
        }

        .tournament-card-actions .btn-details {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            grid-column: 1 / 2;
        }

        .tournament-card-actions .btn-joined {
            background-color: var(--success-color);
            color: var(--text-primary);
            opacity: 0.8;
            grid-column: 2 / 3;
        }

        .tournament-card-actions .btn-disabled {
            background-color: var(--secondary-bg);
            opacity: 0.6;
            cursor: not-allowed;
            grid-column: 2 / 3;
        }

        .btn-idpass {
            background: var(--accent-gradient);
            color: var(--primary-bg);
            border: none;
            font-weight: 600;
        }

        .wallet-card {
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .wallet-card h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border-color);
            /* Added for separation */
        }

        .balance-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
        }

        .balance-item-label {
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .balance-item-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .balance-item-action {
            min-width: 100px;
            text-align: right;
        }

        .balance-item-action .btn-custom-link {
            font-size: 0.85rem;
            color: var(--accent-color);
            padding: 5px;
        }

        .balance-item-action .btn-withdraw {
            background-color: var(--primary-button-bg);
            color: #fff;
            font-size: 0.8rem;
            padding: 5px 12px;
            border-radius: 5px;
            border: none;
        }

        #recentTransactionsListEl .custom-card {
            background-color: var(--secondary-bg);
        }

        #earnings-section .custom-card {
            text-align: center;
        }

        #earnings-section .display-4 {
            font-size: 3rem;
        }

        #earnings-section p strong {
            color: var(--text-primary);
        }

        .profile-header-card {
            background: linear-gradient(145deg, var(--secondary-bg), var(--primary-bg));
            border-radius: 10px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            margin-bottom: 10px;
            border: 2px solid var(--accent-color);
            object-fit: cover;
            background-color: var(--primary-bg);
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .profile-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            word-break: break-all;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .stat-item {
            text-align: center;
            flex: 1;
        }

        .stat-item strong {
            display: block;
            font-size: 1rem;
            font-weight: 600;
        }

        .stat-item span {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .profile-links .list-group {
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .profile-links .form-switch .form-check-input {
            background-color: var(--secondary-bg);
            border-color: var(--border-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='rgba%28255, 255, 255, 0.25%29'/%3e%3csvg%3e");
        }

        .profile-links .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='3' fill='%23fff'/%3e%3csvg%3e");
        }

        #login-section {
            margin-top: 5vh;
        }

        #login-section .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        #login-section .btn-primary {
            background-color: var(--primary-button-bg);
            border: none;
        }

        #login-section .btn-link {
            background: none;
            border: none;
            color: var(--accent-color);
            text-decoration: none;
            font-size: 0.9em;
            padding: 5px 0;
        }

        #login-section .btn-link:hover {
            text-decoration: underline;
        }

        #login-section .btn-success {
            background-color: var(--success-color);
            border: none;
        }

        #login-section .btn-danger {
            background-color: var(--danger-color);
            border: none;
        }

        #login-section .form-divider {
            text-align: center;
            margin: 20px 0;
            position: relative;
            color: var(--text-secondary);
        }

        #login-section .form-divider::before,
        #login-section .form-divider::after {
            content: "";
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: var(--border-color);
        }

        #login-section .form-divider::before {
            left: 0;
        }

        #login-section .form-divider::after {
            right: 0;
        }

        #login-section .form-divider span {
            background-color: var(--card-bg);
            padding: 0 10px;
            position: relative;
            z-index: 1;
            font-size: 0.8rem;
            font-weight: 500;
        }

        #login-section .card-title {
            color: var(--text-primary);
        }

        #googleSignInBtnMainEl {
            display: none;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            border-bottom-color: var(--border-color);
        }

        .modal-footer {
            border-top-color: var(--border-color);
        }

        .btn-close-white {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .modal-body .Khalti-number {
            color: var(--warning-color);
            font-weight: bold;
            user-select: text;
        }

        #matchDetailsModalBodyEl pre {
            background-color: var(--primary-bg);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #policyModalBodyEl {
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        #idPasswordModalEl .copy-btn {
            padding: 2px 6px;
            font-size: 0.8rem;
            margin-left: 8px;
            vertical-align: middle;
        }

        #policyModalBodyEl .copy-btn,
        #policyModalBodyEl #shareReferralBtn {
            padding: 4px 10px;
            font-size: 0.9rem;
        }

        #policyModalBodyEl #shareReferralBtn i,
        #policyModalBodyEl .copy-btn i {
            margin-right: 5px;
        }

        #securityWarning {
            background-color: var(--danger-color);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 60px;
            z-index: 999;
            border-bottom: 1px solid #a51d1d;
        }

        #securityWarning a {
            color: #ffdddd;
            text-decoration: underline;
        }

        #securityWarning button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 2px 8px;
            margin-left: 15px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* New CSS for Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-bg);
            /* Use your primary background color */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            /* Ensure it's on top of everything */
            color: var(--text-primary);
            font-size: 2rem;
            font-weight: 700;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
            /* Allow clicks through once hidden */
        }

        #loading-screen .spinner-border {
            margin-bottom: 20px;
            width: 4rem;
            height: 4rem;
        }

        /* Centering Home Section Content (Example) */
        #home-section .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #home-section .section-title {
            width: 100%;
            /* Ensure title takes full width for centering */
            text-align: center;
        }

        #home-section .row {
            justify-content: center;
            /* Center game cards */
        }

        /* Professionalism adjustments (examples) */
        .custom-card {
            box-shadow: 0 4px 10px (0, 0, 0, 0.2);
            /* Stronger shadow */
        }

        .btn-custom {
            box-shadow: 0 2px 5px (0, 0, 0, 0.2);
            /* Subtle button shadow */
        }

        .btn-custom:active {
            transform: translateY(1px);
            /* Simple press effect */
            box-shadow: 0 1px 3px (0, 0, 0, 0.1);
        }

        .nav-item:active {
            transform: translateY(1px);
        }

        /* New CSS for in-app notification banner */
        #inAppNotificationBanner {
            background-color: var(--info-color);
            color: white;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.9rem;
            position: sticky;
            top: 60px;
            /* Below the header */
            z-index: 998;
            /* Below security warning */
            border-bottom: 1px solid #2a65cc;
            display: none;
            /* Hidden by default */
            cursor: pointer;
        }

        #inAppNotificationBanner.warning {
            background-color: var(--warning-color);
            border-color: #cc7a00;
        }

        #inAppNotificationBanner.danger {
            background-color: var(--danger-color);
            border-color: #a51d1d;
        }

        #inAppNotificationBanner .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            margin-left: 10px;
            cursor: pointer;
            float: right;
        }

        /* NEW CSS FOR GAME ICON IN TOURNAMENT CARD */
        .tournament-game-icon {
            width: 40px;
            /* Adjust size as needed */
            height: 40px;
            /* Adjust size as needed */
            border-radius: 8px;
            /* Slightly rounded corners */
            object-fit: cover;
            margin-right: 10px;
            border: 1px solid var(--border-color);
        }

        /* NEW CSS FOR CONVERSION LOGO BUTTON */
        .conversion-logo-btn {
            width: 50px;
            /* Adjust size as needed */
            height: 50px;
            /* Adjust size as needed */
            border-radius: 50%;
            /* Make it circular */
            font-size: 1.5rem;
            /* Adjust icon size */
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px (0, 0, 0, 0.2);
        }

        .conversion-logo-btn:hover {
            background-color: #334155;
            /* Adjust hover color */
        }

        /* Media query for smaller screens if needed to adjust layout */
        @media (max-width: 576px) {
            .header-time-greeting {
                font-size: 0.75rem;
                /* Smaller font on small screens */
                margin: 0 5px;
            }

            .header-left,
            .header-right {
                gap: 5px;
            }
        }

        /* New CSS for Rank System */
        .rank-list .list-group-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
        }

        .rank-list .rank-info {
            display: flex;
            align-items: center;
        }

        .rank-list .rank-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-right: 15px;
            min-width: 30px;
            text-align: center;
        }

        .rank-list .rank-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 1px solid var(--border-color);
        }

        .rank-list .rank-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .rank-list .rank-earnings {
            font-weight: 700;
            color: var(--success-color);
        }

        /* NEW CSS for Payment Method Selector */
        .payment-methods-selector {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .payment-methods-selector .btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 5px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: var(--secondary-bg);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .payment-methods-selector .btn.active {
            background-color: var(--primary-button-bg);
            color: var(--text-primary);
            border-color: var(--primary-button-bg);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }

        .payment-methods-selector .btn:hover:not(.active) {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }

        .payment-method-details {
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.3s ease-in-out;
        }

        .payment-method-details.active {
            display: block;
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p>Play and Earn</p>
    </div>

    <!-- Firebase Security Rules Warning -->
    <div id="securityWarning" style="display: none;">
        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Security Alert:</strong> Your database rules are
        insecure (public). Anyone can read/write data.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn
            how to secure rules.</a>
        <button onclick="this.parentElement.style.display='none'">Dismiss</button>
    </div>

    <!-- In-App Notification Banner -->
    <div id="inAppNotificationBanner" style="display: none;">
        <span id="notificationMessage"></span>
        <button class="close-btn" onclick="this.parentElement.style.display='none'">&times;</button>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <img src="https://via.placeholder.com/40/FFFFFF/0F172A?text=G" alt="Logo" class="header-logo"
                id="appLogoEl">
            <div class="header-title" id="headerTitleContainerEl"> Welcome <span id="headerUserGreetingEl">Guest</span>
            </div>
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div>
        </div>
        <!-- New element for time and greeting -->
        <div class="header-time-greeting" id="headerTimeGreetingEl"></div>
        <div class="header-right">
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span
                    class="notification-badge" style="display: none;"></span> </button>
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i
                    class="bi bi-wallet-fill"></i> Rs<span id="headerChipBalanceEl">0</span> </button>
            <!-- New: Create Room Button in Header -->
            <button class="header-create-room-button" id="createRoomBtnEl">
                <i class="bi bi-plus-circle-fill"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-content">
        <div id="globalLoaderEl">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>

        <!-- Login Section -->
        <section id="login-section" class="section">
            <div class="container" style="max-width: 450px;">
                <div class="card shadow-sm custom-card">
                    <div class="card-body p-4">
                        <!-- Login Form -->
                        <form id="emailLoginForm">
                            <h2 class="card-title text-center mb-4">Login</h2>
                            <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input
                                    type="email" class="form-control" id="loginEmailInputEl"
                                    placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label>
                                <input type="password" class="form-control" id="loginPasswordInputEl"
                                    placeholder="Password" required> </div>
                            <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button"
                                    class="btn btn-custom btn-custom-primary" id="loginEmailBtnEl">Login</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block"
                                    id="showSignupToggleBtnEl">Need an account? Sign Up</button> <a href="#"
                                    id="forgotPasswordLinkEl" class="text-center small mt-2 d-block"
                                    style="color: var(--text-secondary);">Forgot Password?</a> </div>
                        </form>

                        <!-- Signup Form (Initially Hidden) -->
                        <form id="emailSignupForm" style="display: none;">
                            <h2 class="card-title text-center mb-4">Sign Up</h2>
                            <div class="mb-3"> <label for="signupDisplayNameInputEl"
                                    class="form-label">Username</label> <input type="text" class="form-control"
                                    id="signupDisplayNameInputEl" placeholder="Choose a username" required> </div>
                            <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input
                                    type="email" class="form-control" id="signupEmailInputEl"
                                    placeholder="name@example.com" required> </div>
                            <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6
                                    chars)</label> <input type="password" class="form-control"
                                    id="signupPasswordInputEl" placeholder="Password" required minlength="6"> </div>
                            <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm
                                    Password</label> <input type="password" class="form-control"
                                    id="signupConfirmPasswordInputEl" placeholder="Confirm Password" required> </div>
                            <!-- *** REFERRAL CODE INPUT ADDED *** -->
                            <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code
                                    (Optional)</label> <input type="text" class="form-control"
                                    id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div>
                            <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                            <div class="d-grid gap-2 mb-3"> <button type="button"
                                    class="btn btn-custom btn-custom-accent" id="signupEmailBtnEl">Sign Up</button>
                                <button type="button" class="btn-custom-link btn-sm p-0 text-center d-block"
                                    id="showLoginToggleBtnEl">Already have account? Login</button> </div>
                        </form>

                    </div>
                </div>
            </div>
        </section>

        <!-- Home Section -->
        <section id="home-section" class="section">
            <!-- Promotion Slider -->
            <div class="swiper-container" id="promotionSliderEl">
                <div class="swiper-wrapper placeholder-glow">
                    <div class="swiper-slide"><span class="placeholder"
                            style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>
                </div>
                <div class="swiper-pagination"></div>
            </div>

            <!-- Esport Games -->
            <h2 class="section-title">Esport Games</h2>
            <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                <!-- Placeholder Game Cards -->
                <div class="col-6">
                    <div class="game-card custom-card"><span class="placeholder d-block"
                            style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span
                            class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                </div>
                <div class="col-6">
                    <div class="game-card custom-card"><span class="placeholder d-block"
                            style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span
                            class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                </div>
            </div>

            <!-- My Contests -->
            <h2 class="section-title">My Contests</h2>
            <div id="myContestsListEl" class="placeholder-glow">
                <!-- Placeholder Contest Card -->
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"></span> <span
                        class="placeholder col-12 mt-2"></span> <span class="placeholder col-10 mt-2"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
                <p id="noContestsMessageEl" class="text-secondary text-center" style="display: none;">You haven't
                    joined any contests yet.</p>
            </div>
        </section>

        <!-- Tournaments Section -->
        <section id="tournaments-section" class="section">
            <div class="tournament-tabs">
                <button class="tab-item active" data-status="upcoming" data-type="regular"><i
                        class="bi bi-calendar-event-fill"></i> Upcoming</button>
                <button class="tab-item" data-status="ongoing" data-type="regular"><i
                        class="bi bi-play-circle-fill"></i> Ongoing</button>
                <button class="tab-item" data-status="completed" data-type="regular"><i class="bi bi-trophy-fill"></i>
                    Results</button>
                <button class="tab-item" data-type="custom"><i class="bi bi-controller"></i> Custom Rooms</button>
            </div>
            <div id="tournamentsListContainerEl" class="mt-3 placeholder-glow">
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"></span> <span
                        class="placeholder col-12 mt-2"></span> <span class="placeholder col-10 mt-2"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
            </div>
            <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No
                tournaments found.</p>
        </section>

        <!-- Rank Section (New) -->
        <section id="rank-section" class="section">
            <h2 class="section-title text-center">Top Earners</h2>
            <div class="custom-card">
                <div id="rankListEl" class="list-group rank-list">
                    <!-- Rank items will be dynamically loaded here -->
                    <div class="list-group-item placeholder-glow">
                        <span class="placeholder col-1" style="height: 20px;"></span>
                        <div class="rank-info">
                            <span class="placeholder rank-avatar"
                                style="width: 40px; height: 40px; border-radius: 50%;"></span>
                            <span class="placeholder col-6" style="height: 20px;"></span>
                        </div>
                        <span class="placeholder col-3" style="height: 20px;"></span>
                    </div>
                    <div class="list-group-item placeholder-glow">
                        <span class="placeholder col-1" style="height: 20px;"></span>
                        <div class="rank-info">
                            <span class="placeholder rank-avatar"
                                style="width: 40px; height: 40px; border-radius: 50%;"></span>
                            <span class="placeholder col-6" style="height: 20px;"></span>
                        </div>
                        <span class="placeholder col-3" style="height: 20px;"></span>
                    </div>
                </div>
                <p id="noRankDataMessageEl" class="text-secondary text-center mt-3" style="display: none;">No rank data
                    available.</p>
            </div>
        </section>

        <!-- Wallet Section -->
        <section id="wallet-section" class="section">
            <div class="wallet-card custom-card">
                <h2 class="section-title mb-4">Wallet</h2>

                <!-- Total Balance - More prominent -->
                <div class="balance-item placeholder-glow"
                    style="border-bottom: none; padding-bottom: 0; margin-bottom: 20px;">
                    <span class="balance-item-label" style="font-size: 1.1rem; font-weight: 600;">Your Total
                        Balance</span>
                    <span class="balance-item-value text-accent" id="walletTotalBalanceEl" style="font-size: 1.8rem;">
                        <span class="placeholder col-4"></span>
                    </span>
                </div>

                <hr style="border-top: 1px dashed var(--border-color); margin: 15px 0;">

                <!-- Winning Cash -->
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Winning Cash</span>
                    <span class="balance-item-value" id="walletWinningCashEl">
                        <span class="placeholder col-3"></span>
                    </span>
                    <div class="balance-item-action">
                        <button class="btn-withdraw" id="withdrawBtnEl">Withdraw</button>
                    </div>
                </div>

                <!-- Bonus Cash -->
                <div class="balance-item placeholder-glow">
                    <span class="balance-item-label">Bonus Cash</span>
                    <span class="balance-item-value" id="walletBonusCashEl">
                        <span class="placeholder col-3"></span>
                    </span>
                    <div class="balance-item-action" style="min-width: 100px;"></div>
                </div>

                <hr style="border-top: 1px dashed var(--border-color); margin: 15px 0;">

                <!-- Conversion Logo -->
                <div class="d-flex justify-content-center my-3">
                If You want to convert your winng cash to Your play able Total balance Then contact us at 9764503093
                </div>

                <!-- Action Buttons -->
                <button class="btn btn-custom btn-custom-secondary w-100 mt-4" id="addAmountWalletBtnEl">
                    <i class="bi bi-plus-circle-fill me-2"></i>Add Amount
                </button>
            </div>

            <h3 class="section-title mt-4">Recent Transactions</h3>
            <div id="recentTransactionsListEl" class="placeholder-glow">
                <div class="custom-card p-2 mb-2 placeholder-glow">
                    <div class="d-flex justify-content-between"> <span class="placeholder col-5"></span> <span
                            class="placeholder col-3"></span> </div>
                    <div class="small text-secondary mt-1"><span class="placeholder col-6"></span></div>
                </div>
                <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading
                    transactions...</p>
            </div>
        </section>

        <!-- Make Room Section (New) -->
        <section id="make-room-section" class="section">
            <h2 class="section-title">All Custom Rooms</h2>
            <div id="myCustomRoomsListEl" class="placeholder-glow">
                <!-- Placeholder Custom Room Card -->
                <div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"></span> <span
                        class="placeholder col-12 mt-2"></span> <span class="placeholder col-10 mt-2"></span>
                    <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> <span class="placeholder col-4"
                            style="height: 30px; border-radius: 6px;"></span> </div>
                </div>
                <p id="noCustomRoomsMessageEl" class="text-secondary text-center" style="display: none;">No custom
                    rooms available. Be the first to create one!</p>
            </div>
        </section>

        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="profile-header-card placeholder-glow"> <img src="https://via.placeholder.com/70" alt="Avatar"
                    class="profile-avatar" id="profileAvatarEl">
                <h3 class="profile-name mt-2" id="profileNameEl"><span class="placeholder col-6"></span></h3>
                <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
                <div class="profile-stats w-100">
                    <div class="stat-item"><strong id="profileTotalMatchesEl"><span
                                class="placeholder col-4"></span></strong><span>Matches Played</span></div>
                    <div class="stat-item"><strong id="profileWonMatchesEl"><span
                                class="placeholder col-4"></span></strong><span>Matches Won</span></div>
                    <div class="stat-item"><strong id="profileTotalEarningsEl"><span
                                class="placeholder col-4"></span></strong><span>Total Winnings</span></div>
                </div>
            </div>
            <div class="profile-links">
                <div class="list-group custom-card">
                    <label
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item">
                        <span><i class="bi bi-bell-fill"></i> Notifications</span>
                        <div class="form-check form-switch"> <input class="form-check-input" type="checkbox"
                                role="switch" id="notificationSwitchEl" checked> </div>
                    </label>
                    <!-- New: Edit Profile Link -->
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        id="editProfileLinkEl"> <span><i class="bi bi-person-circle"></i> Edit Profile</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <!-- New: Change Password Link -->
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        id="changePasswordLinkEl"> <span><i class="bi bi-key-fill"></i> Change Password</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="refer"> <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span> <i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="privacy"> <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="terms"> <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="refund"> <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="fairPlay"> <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <!-- NEW: Contact Info Link -->
                    <a href="#"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center interactive-list-item"
                        data-policy="contact"> <span><i class="bi bi-telephone-fill"></i> Contact Info</span><i
                            class="bi bi-chevron-right"></i> </a>
                    <!-- REMOVED: Message Admin Link -->
                    <button
                        class="list-group-item list-group-item-action text-danger d-flex justify-content-between align-items-center interactive-list-item"
                        id="logoutProfileBtnEl"> <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span>
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Modals -->
    <div class="modal fade" id="policyModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addAmountModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> How to Add Amount?</h5><button
                        type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Payment Method Selector Buttons -->
                    <div class="payment-methods-selector">
                        <button class="btn btn-custom" data-method="esewa">fone pay</button>
                    </div>

                    <!-- Payment Details Container -->
                    <div class="payment-details-container">
                        <!-- Esewa Details -->
                        <div class="payment-method-details" data-method="esewa">
                            <p>please write your gmail in remarks
<br>To add amount, pay via Esewa ,bank ,khalti to:</p>
                            <p class="text-center">
                                <img src="https://i.ibb.co/fzWDP8M8/IMG-20251209-113636.jpg" alt="Esewa QR" height="250"
                                    width="245" class="img-fluid">
                            </p>
                            <p class="text-center text-warning"><strong>For any problem or no deposit whats app :</strong> <span
                                    class="Khalti-number">9764503093</span></p>
                        </div>

                        <!-- Esewa 2 Details -->
                        <div class="payment-method-details" data-method="esewa2">
                            <p>To add amount, pay via Esewa 2 to:</p>
                            <p class="text-center">
                                <img src="https://i.ibb.co/vCjHQh8W/Esewa2.jpg" alt="Esewa 2 QR"
                                    height="250" width="245" class="img-fluid">
                            </p>
                            <p class="text-center text-warning"><strong>Esewa 2 ID/Number:</strong> <span
                                    class="Khalti-number">9846642239</span></p>
                        </div>

                        <!-- Khalti Details -->
                        <div class="payment-method-details" data-method="khalti">
                            <p>To add amount, pay via Khalti to:</p>
                            <p class="text-center">
                                <img src="https://i.ibb.co/fdQzfqxT/IMG-20250907-123133.jpg" alt="Khalti QR" height="250"
                                    width="245" class="img-fluid">
                            </p>
                            <p class="text-center text-warning"><strong>Khalti ID/Number:</strong> <span
                                    class="Khalti-number">9846642239</span></p>
                        </div>

                        <!-- IME Pay Details -->
                        <div class="payment-method-details" data-method="imepay">
                            <p>To add amount, pay via IME Pay to:</p>
                            <p class="text-center">
                                <img src="https://i.ibb.co/k603j74x/IMG-20250907-123341.jpg" alt="IME Pay QR"
                                    height="250" width="245" class="img-fluid">
                            </p>
                            <p class="text-center text-warning"><strong>IME Pay ID/Number:</strong> <span
                                    class="Khalti-number">9764503093</span></p>
                        </div>

                        <!-- Bank Account Details -->
                        <div class="payment-method-details" data-method="bank">
                            <p>To add amount, pay via Bank Transfer to:</p>
                            <p class="text-center">
                                <img src="https://i.ibb.co/QWbQz2j/Bank.jpg" alt="Bank QR" height="250"
                                    width="245" class="img-fluid">
                            </p>
                            <p class="text-center text-warning"><strong>Bank Name:</strong> Siddhartha Bank</p>
                            <p class="text-center text-warning"><strong>Account Name:</strong> BIJAY CHALISE</p>
                            <p class="text-center text-warning"><strong>Account Number:</strong>55509348351 </p>
                        </div>
                    </div>

                    <p class="mt-3 small"><strong><i class="bi bi-exclamation-triangle-fill text-warning"></i>
                            IMPORTANT:</strong> After payment, contact admin via <span
                            id="adminContactInfo">chalisebijay950@gmail.com</span> with
                        registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount
                        added manually after
                        verification.</p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Got it</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="withdrawModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button
                        type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Withdrawable balance: <strong class="text-light"
                            id="withdrawModalBalanceEl">Rs0.00</strong></p>
                    <div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min Rs<span
                                id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control"
                            id="withdrawAmountInputEl" placeholder="Enter amount"></div>
                    <div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method
                            (Esewa/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl"
                            placeholder="Enter Esewa ID / Bank Details"></div>
                    <div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button><button type="button"
                        class="btn btn-custom btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit
                        Request</button></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="matchDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="matchDetailsModalBodyEl"></div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="idPasswordModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Room ID & Password</h5><button type="button"
                        class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="small text-secondary">ID/Pass shown shortly before match start.</p>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Room ID:</p>
                        <h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span
                                class="placeholder col-6"></span></h4><button
                            class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl"
                            title="Copy Room ID"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;">
                        <p class="mb-1">Password:</p>
                        <h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span
                                class="placeholder col-6"></span></h4><button
                            class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl"
                            title="Copy Password"><i class="bi bi-clipboard"></i></button>
                    </div>
                    <p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share
                        ID/Password.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Game UID and Name -->
    <div class="modal fade" id="gameDetailsModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-controller me-2"></i> Enter Game Details</h5><button
                        type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Please provide your in-game details to join the tournament.</p>
                    <div class="mb-3">
                        <label for="gameUidInputEl" class="form-label">In-Game UID</label>
                        <input type="text" class="form-control" id="gameUidInputEl" placeholder="Your in-game User ID"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="gameNameInputEl" class="form-label">In-Game Name</label>
                        <input type="text" class="form-control" id="gameNameInputEl"
                            placeholder="Your in-game username" required>
                    </div>
                   <div class="mb-3">
                        <label for="gameNameInputEl" class="form-label">Friends uid if Squad eg 123,456,789</label>
                        <input type="text" class="form-control" id="gameNameInputEl"
                            placeholder="friend uid 1 , friend uid 2 ,friend uid 3">
        </div>
                   <div class="mb-3">
                        <label for="gameNameInputEl" class="form-label">In-Game Friends Name(if squad)eg ab,bc,cd</label>
                        <input type="text" class="form-control" id="gameNameInputEl"
                            placeholder="Friend 1 , friend 2, friend 3 " >
                    </div>
                    
                    <div id="gameDetailsStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button><button type="button"
                        class="btn btn-custom btn-custom-primary" id="submitGameDetailsBtnEl">Submit & Join</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Edit Profile -->
    <div class="modal fade" id="editProfileModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-circle me-2"></i> Edit Profile</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editDisplayNameInputEl" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editDisplayNameInputEl"
                            placeholder="Your username" required>
                    </div>
                    <div id="editProfileStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="saveProfileChangesBtnEl">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Convert Winning Cash -->
    <div class="modal fade" id="convertWinningCashModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-arrow-repeat me-2"></i> Convert Winning Cash</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-secondary">Your current Winning Cash: <strong class="text-light"
                            id="convertWinningCashBalanceEl">Rs0.00</strong></p>
                    <div class="mb-3">
                        <label for="convertAmountInputEl" class="form-label">Amount to Convert</label>
                        <input type="number" class="form-control" id="convertAmountInputEl" placeholder="Enter amount"
                            required>
                    </div>
                    <div class="alert alert-warning small" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> This action cannot be undone. Converted cash
                        will be added to your main balance and cannot be withdrawn as winning cash.
                    </div>
                    <div id="convertWinningCashStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary"
                        id="submitConvertWinningCashBtnEl">Convert</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for App Update -->
    <div class="modal fade" id="appUpdateModalEl" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cloud-arrow-down-fill me-2"></i> New Update Available!</h5>
                </div>
                <div class="modal-body text-center">
                    <p>A new version of the app is available. Please update to get the latest features and bug fixes.
                    </p>
                    <p class="fw-bold">Current Version: <span id="currentAppVersionEl">1.0.4</span></p>
                    <p class="fw-bold">New Version: <span id="newAppVersionEl"></span></p>
                    <!-- What's New Section -->
                    <div id="whatsNewContainer" style="margin-top: 20px; text-align: left;">
                        <h6 class="fw-bold">What's New:</h6>
                        <div id="whatsNewContent"
                            style="white-space: pre-wrap; font-size: 0.9rem; color: var(--text-secondary);">
                            <!-- Content will be loaded here by JavaScript -->
                        </div>
                    </div>
                    <a href="#" id="updateAppBtnEl" target="_blank" rel="noopener noreferrer"
                        class="btn btn-custom btn-custom-accent mt-3">
                        <i class="bi bi-download me-2"></i> Download Update
                    </a>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-custom btn-custom-secondary" id="remindMeLaterBtnEl">Remind Me
                        Later</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Create Room -->
    <div class="modal fade" id="createRoomModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle-fill me-2"></i> Create New Room</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createRoomForm">
                        <p class="small text-secondary">Cost to create a room: Rs<span id="roomCreationFeeEl">25</span>.
                            You can create up to <span id="maxRoomsAllowedEl">10</span> rooms.</p>
                        <div class="mb-3">
                            <label for="roomGameIdInput" class="form-label">Game</label>
                            <select class="form-control" id="roomGameIdInput" required>
                                <option value="">Select a Game</option>
                                <!-- Options will be dynamically loaded -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="roomNameInput" class="form-label">Room Name</label>
                            <input type="text" class="form-control" id="roomNameInput"
                                placeholder="e.g., Daily Scrims, Custom Match" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="roomEntryFeeInput" class="form-label">Entry Fee (Rs)</label>
                                <input type="text" class="form-control" id="roomEntryFeeInput" value="30" disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="roomPrizePoolInput" class="form-label">Prize Pool (Rs)</label>
                                <input type="text" class="form-control" id="roomPrizePoolInput" value="0" disabled
                                    data-prize-pool="0">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="roomMaxPlayersInput" class="form-label">Max Players</label>
                                <input type="text" class="form-control" id="roomMaxPlayersInput" value="0"
                                    data-max-players="0">
                            </div>
                            <div class="col-md-6">
                                <label for="roomModeInput" class="form-label">Mode</label>
                                <input type="text" class="form-control" id="roomModeInput"
                                    placeholder="e.g., Squad, Duo, Solo">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="roomMapInput" class="form-label">Map</label>
                            <input type="text" class="form-control" id="roomMapInput"
                                placeholder="e.g., Erangel, Bermuda">
                        </div>
                        <div class="mb-3">
                            <label for="roomDescriptionInput" class="form-label">Description / Rules</label>
                            <textarea class="form-control" id="roomDescriptionInput" rows="3"
                                placeholder="Any specific rules or details for the room"></textarea>
                        </div>
                        <div id="createRoomStatusMessage" class="alert mt-3" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="submitCreateRoomBtn">Create
                        Room</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Modal for Edit Room (ID/Password) -->
    <div class="modal fade" id="editRoomModalEl" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i> Edit Room Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editRoomIdHiddenEl">
                    <p class="small text-secondary">Update Room ID and Password for your custom room.</p>
                    <div class="mb-3">
                        <label for="editRoomIDInput" class="form-label">Room ID</label>
                        <input type="text" class="form-control" id="editRoomIDInput" placeholder="Enter Room ID"
                            required>
                    </div>
                    <div class="mb-3">
                        <label for="editRoomPasswordInput" class="form-label">Room Password</label>
                        <input type="text" class="form-control" id="editRoomPasswordInput"
                            placeholder="Enter Room Password" required>
                    </div>
                    <div id="editRoomStatusMessage" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-custom btn-custom-secondary"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom btn-custom-primary" id="submitEditRoomBtn">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item" data-section="rank-section"><i
                class="bi bi-trophy-fill"></i><span>Rank</span></button>
        <button class="nav-item" data-section="wallet-section"><i
                class="bi bi-wallet-fill"></i><span>Wallet</span></button>
        <button class="nav-item active" data-section="home-section"><i
                class="bi bi-house-door-fill"></i><span>Home</span></button>
        
        <button class="nav-item" data-section="profile-section"><i
                class="bi bi-person-fill"></i><span>Profile</span></button>
    </nav>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <!-- Firebase SDK & App Logic -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, orderByChild, equalTo, onValue, runTransaction, off, limitToLast, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"; // Added serverTimestamp, remove
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"; // Added updateProfile

        // ===============================================================
        // ================= !!! IMPORTANT !!! ===========================
        // Replace the placeholder values below with your actual Firebase project configuration.
        // You can find these details in your Firebase project settings:
        // Project settings > General > Your apps > Web app > SDK setup and configuration > Config
        // ===============================================================
        const firebaseConfig = {
               apiKey: "AIzaSyBorWE4ROgbV_u86WmT5ld1igCpil4vahk",
               authDomain: "battle-league-d0a10.firebaseapp.com",
               databaseURL: "https://battle-league-d0a10-default-rtdb.firebaseio.com",
               projectId: "battle-league-d0a10",
               storageBucket: "battle-league-d0a10.firebasestorage.app",
               messagingSenderId: "353601989731",
               appId: "1:353601989731:web:c8c881b95432e5ebd69c56"
};
        // ===============================================================
        // ===============================================================

        // Initialize Firebase
        let app, db, auth;
        try {
            // Check if placeholder values are still present
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.warn("Firebase config using placeholder values. Replace them with your actual project details.");
                // Optionally prevent initialization or show a UI warning here
                // For this example, we'll allow initialization but log the warning.
            }
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            auth = getAuth(app);
            console.log("Firebase Initialized (check config if using placeholders)");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0" style="z-index: 10000;">Critical Error: Could not connect. Check Firebase config & console. Error: ${error.message}</div>`;
        }

        // --- DOM Elements Cache ---
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        const elements = {
            sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'),
            headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'),
            createRoomBtn: getElement('createRoomBtnEl'), // New: Create Room Button in Header

            loginSection: getElement('login-section'),
            // Login Form Elements
            emailLoginForm: getElement('emailLoginForm'),
            loginEmailInput: getElement('loginEmailInputEl'),
            loginPasswordInput: getElement('loginPasswordInputEl'),
            loginEmailBtn: getElement('loginEmailBtnEl'),
            showSignupToggleBtn: getElement('showSignupToggleBtnEl'),
            loginStatusMessage: getElement('loginStatusMessageEl'),
            forgotPasswordLink: getElement('forgotPasswordLinkEl'),
            // Signup Form Elements
            emailSignupForm: getElement('emailSignupForm'),
            signupDisplayNameInput: getElement('signupDisplayNameInputEl'), // Added for username
            signupEmailInput: getElement('signupEmailInputEl'),
            signupPasswordInput: getElement('signupPasswordInputEl'),
            signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'),
            signupReferralCodeInput: getElement('signupReferralCodeInputEl'), // <<< Added Referral Code Input Element
            signupEmailBtn: getElement('signupEmailBtnEl'),
            showLoginToggleBtn: getElement('showLoginToggleBtnEl'),
            signupStatusMessage: getElement('signupStatusMessageEl'),
            homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), gamesList: getElement('gamesListEl'), myContestsList: getElement('myContestsListEl'), noContestsMessage: getElement('noContestsMessageEl'),
            tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'),
            // New: Rank Section
            rankSection: getElement('rank-section'),
            rankList: getElement('rankListEl'),
            noRankDataMessage: getElement('noRankDataMessageEl'),

            walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'),
            // Removed: earningsSection: getElement('earnings-section'), earningsTotal: getElement('earningsTotalEl'), earningsReferral: getElement('earningsReferralEl'), viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'),
            // New: Make Room Section
            makeRoomSection: getElement('make-room-section'),
            myCustomRoomsList: getElement('myCustomRoomsListEl'),
            noCustomRoomsMessage: getElement('noCustomRoomsMessageEl'),

            profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a[data-policy], .profile-links button[data-policy]'), notificationSwitch: getElement('notificationSwitchEl'),
            policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'),
            addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, modalUserEmail: getElement('modalUserEmailEl'),
            // NEW: Payment method selector elements
            paymentMethodButtons: querySelAll('#addAmountModalEl .payment-methods-selector .btn'),
            paymentMethodDetails: querySelAll('#addAmountModalEl .payment-method-details'),

            withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'),
            matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'),
            idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'),
            securityWarning: getElement('securityWarning'),
            // New elements for game details modal
            gameDetailsModalInstance: getElement('gameDetailsModalEl') ? new bootstrap.Modal(getElement('gameDetailsModalEl')) : null,
            gameUidInput: getElement('gameUidInputEl'),
            gameNameInput: getElement('gameNameInputEl'),
            gameDetailsStatusMessage: getElement('gameDetailsStatusMessageEl'),
            submitGameDetailsBtn: getElement('submitGameDetailsBtnEl'),
            // New elements for Edit Profile Modal
            editProfileModalInstance: getElement('editProfileModalEl') ? new bootstrap.Modal(getElement('editProfileModalEl')) : null,
            editDisplayNameInput: getElement('editDisplayNameInputEl'),
            editProfileStatusMessage: getElement('editProfileStatusMessageEl'),
            saveProfileChangesBtn: getElement('saveProfileChangesBtnEl'),
            editProfileLink: getElement('editProfileLinkEl'),
            // New elements for Change Password Link
            changePasswordLink: getElement('changePasswordLinkEl'),
            // New elements for Convert Winning Cash
            convertWinningCashBtn: getElement('convertWinningCashBtnEl'),
            convertWinningCashModalInstance: getElement('convertWinningCashModalEl') ? new bootstrap.Modal(getElement('convertWinningCashModalEl')) : null,
            convertWinningCashBalance: getElement('convertWinningCashBalanceEl'),
            convertAmountInput: getElement('convertAmountInputEl'),
            convertWinningCashStatusMessage: getElement('convertWinningCashStatusMessageEl'),
            submitConvertWinningCashBtn: getElement('submitConvertWinningCashBtnEl'),
            // New elements for App Update Modal
            appUpdateModalInstance: getElement('appUpdateModalEl') ? new bootstrap.Modal(getElement('appUpdateModalEl')) : null,
            currentAppVersionEl: getElement('currentAppVersionEl'),
            newAppVersionEl: getElement('newAppVersionEl'),
            updateAppBtnEl: getElement('updateAppBtnEl'),
            remindMeLaterBtnEl: getElement('remindMeLaterBtnEl'),
            whatsNewContent: getElement('whatsNewContent'), // NEW: What's New content element
            whatsNewContainer: getElement('whatsNewContainer'), // NEW: What's New container element
            // New: Loading Screen Element
            loadingScreen: getElement('loading-screen'),
            // New: In-App Notification Banner
            inAppNotificationBanner: getElement('inAppNotificationBanner'),
            notificationMessage: getElement('notificationMessage'),
            // NEW: Time and Greeting Element
            headerTimeGreeting: getElement('headerTimeGreetingEl'),
            // New: Create Room Modal Elements
            createRoomModalInstance: getElement('createRoomModalEl') ? new bootstrap.Modal(getElement('createRoomModalEl')) : null,
            createRoomForm: getElement('createRoomForm'),
            roomGameIdInput: getElement('roomGameIdInput'),
            roomNameInput: getElement('roomNameInput'),
            roomEntryFeeInput: getElement('roomEntryFeeInput'),
            roomPrizePoolInput: getElement('roomPrizePoolInput'),
            // roomPerKillPrizeInput: getElement('roomPerKillPrizeInput'), // REMOVED
            roomMaxPlayersInput: getElement('roomMaxPlayersInput'),
            roomModeInput: getElement('roomModeInput'),
            roomMapInput: getElement('roomMapInput'),
            roomDescriptionInput: getElement('roomDescriptionInput'),
            // roomIDInput: getElement('roomIDInput'), // REMOVED
            // roomPasswordInput: getElement('roomPasswordInput'), // REMOVED
            createRoomStatusMessage: getElement('createRoomStatusMessage'),
            submitCreateRoomBtn: getElement('submitCreateRoomBtn'),
            roomCreationFeeEl: getElement('roomCreationFeeEl'),
            maxRoomsAllowedEl: getElement('maxRoomsAllowedEl'),
            // NEW: Edit Room Modal Elements
            editRoomModalInstance: getElement('editRoomModalEl') ? new bootstrap.Modal(getElement('editRoomModalEl')) : null,
            editRoomIdHiddenEl: getElement('editRoomIdHiddenEl'),
            editRoomIDInput: getElement('editRoomIDInput'),
            editRoomPasswordInput: getElement('editRoomPasswordInput'),
            editRoomStatusMessage: getElement('editRoomStatusMessage'),
            submitEditRoomBtn: getElement('submitEditRoomBtn')
        };

        // --- App State ---
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let validReferrerUid = null; // <<< To store referrer UID temporarily
        let pendingJoinTournamentData = null; // To store tournament data for join after game details are entered
        const ROOM_CREATION_FEE = 25; // Cost to create a room (UPDATED)
        const DEFAULT_ENTRY_FEE = 30; // Fixed entry fee for custom rooms
        const CUSTOM_ROOM_PRIZE_POOL = 500; // Fixed prize pool for user-created custom rooms
        const MAX_CUSTOM_ROOMS = 10; // Maximum rooms a user can create
        // Removed: CUSTOM_ROOM_DURATION_MINUTES = 60; // Custom room duration in minutes (1 hour)
        // Removed: MIN_PLAYERS_FOR_CUSTOM_ROOM = 10; // Minimum players required for a custom room to not be deleted
        // Removed: CUSTOM_ROOM_START_GRACE_PERIOD_MINUTES = 30; // Grace period for custom room to start after reaching min players

        // =========================================================================
        // --- NEW: THEME MANAGEMENT ---
        // =========================================================================
        const defaultTheme = {
            '--primary-bg': '#0F172A',
            '--secondary-bg': '#1E293B',
            '--card-bg': '#1E293B',
            '--text-primary': '#E2E8F0',
            '--text-secondary': '#94A3B8',
            '--accent-color': '#FACC15',
            '--accent-gradient': 'linear-gradient(to right, #FACC15, #FBBF24)',
            '--primary-button-bg': '#3B82F6',
            '--border-color': '#334155',
            '--bottom-nav-bg': '#1E293B',
            '--success-color': '#10B981',
            '--danger-color': '#EF4444',
            '--warning-color': '#F59E0B',
            '--info-color': '#3B82F6'
        };

        /**
         * Applies a theme object to the document's root CSS variables.
         * @param {object | null} theme - The theme object with CSS variable keys and color values.
         * If null, it resets the theme to the stylesheet defaults.
         */
        function applyTheme(theme) {
            const root = document.documentElement;
            if (theme && typeof theme === 'object') {
                console.log("Applying custom theme:", theme);
                // Apply all properties from the theme object
                for (const property in defaultTheme) {
                    if (theme[property]) {
                        root.style.setProperty(property, theme[property]);
                    } else {
                        // If a property is missing in the new theme, remove it to fall back to default
                        root.style.removeProperty(property);
                    }
                }
            } else {
                console.log("Resetting to default theme.");
                // Reset to default by removing all inline styles
                for (const property in defaultTheme) {
                    root.style.removeProperty(property);
                }
            }
        }
        // =========================================================================
        // --- END OF THEME MANAGEMENT ---
        // =========================================================================

        // --- App Version (Client-side) ---
        // IMPORTANT: Update this version number manually for each new release.
        // This will be compared against the 'latestAppVersion' in Firebase settings.
        const CURRENT_APP_VERSION = "1.0.5"; // <<< Set your current app version here

        // --- Utility Functions ---
        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type} mt-3`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        function copyToClipboard(targetSelector) { // <<< Modified to accept selector
            if (!targetSelector) { alert('Copy target not defined.'); return; }
            const targetElement = querySel(targetSelector);
            if (!targetElement) { alert('Element to copy from not found.'); return; }
            const textToCopy = targetElement.textContent;
            if (!textToCopy || textToCopy === 'N/A' || textToCopy.includes('placeholder')) { alert('Nothing to copy.'); return; }
            navigator.clipboard.writeText(textToCopy).then(() => alert('Copied!'))
                .catch(err => { console.error('Failed to copy:', err); alert('Failed to copy.'); });
        }
        function shareReferral(code) { if (!navigator.share) { alert('Web Share not supported. Copy the code manually.'); return; } if (!code || code === 'N/A') { alert('Referral code not available.'); return; } navigator.share({ title: 'Join Me on Gaming Tournament!', text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`, url: window.location.origin }).catch((error) => console.log('Error sharing', error)); }
        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        function getTimeRemaining(startTime) { if (!startTime) return 'TBA'; const now = Date.now(); const diff = startTime - now; if (diff <= 0) return 'Starting Soon'; const days = Math.floor((diff / 86400000)); const hours = Math.floor(((diff % 86400000) / 3600000)); const minutes = Math.floor(((diff % 3600000) / 60000)); let o = ''; if (days > 0) o += `${days}d `; if (hours > 0 || days > 0) o += `${hours}h `; o += `${minutes}m`; return o.trim() || 'Now'; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };

        // Function to compare version strings (e.g., "1.0.1" vs "1.1.0")
        function compareVersions(v1, v2) {
            const parts1 = v1.split('.').map(Number);
            const parts2 = v2.split('.').map(Number);
            for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                const p1 = parts1[i] || 0;
                const p2 = parts2[i] || 0;
                if (p1 > p2) return 1; // v1 is greater
                if (p1 < p2) return -1; // v2 is greater
            }
            return 0; // versions are equal
        }

        // --- UI Functions ---
        function showSection(sectionId) {
            if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
            const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
            const protectedSections = ['home-section', 'wallet-section', 'profile-section', 'tournaments-section', 'rank-section', 'make-room-section']; // Updated for rank-section and make-room-section
            const isLoggedIn = !!currentUser;
            if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
            if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }
            elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
            updateHeaderForSection(sectionId);
            elements.bottomNavItems.forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            // Load data *after* section is made active
            console.log(`Loading data for section: ${sectionId}`); // <<< Added Log
            switch (sectionId) {
                case 'home-section': loadHomePageData(); break;
                case 'wallet-section': loadWalletData(); break;
                case 'profile-section': loadProfileData(); break;
                case 'rank-section': loadRankData(); break; // New: Load Rank Data
                case 'make-room-section': loadMyCustomRooms(); break; // New: Load My Custom Rooms
                case 'tournaments-section':
                    // Tournament data loaded when clicking a game or tab
                    // Ensure the initial view is populated if landing here directly
                    if (currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        const activeType = querySel('.tournament-tabs .tab-item.active')?.dataset.type || 'regular';
                        filterTournaments(currentTournamentGameId, activeTab, activeType);
                    } else {
                        // Maybe show a message or default to first game?
                        elements.tournamentsListContainer.innerHTML = '<p class="text-secondary text-center mt-4">Select a game from Home page first.</p>';
                    }
                    break;
            }
            // Ensure login/signup form state is correct when showing login section
            if (sectionId === 'login-section') { toggleLoginForm(true); } // Default to showing login form
            window.scrollTo(0, 0);
        }
        function updateHeaderForSection(sectionId) {
            const showBackButton = (sectionId === 'tournaments-section');
            const showCreateRoomBtn = (sectionId === 'make-room-section'); // Show + icon for make-room section

            const defaultTitleVisible = !showBackButton;
            const gameTitleVisible = showBackButton;

            if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
            if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
            if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
            if (elements.createRoomBtn) {
                elements.createRoomBtn.style.display = showCreateRoomBtn ? 'block' : 'none'; // Control visibility of + icon
                elements.createRoomBtn.classList.toggle('highlight', showCreateRoomBtn); // Highlight the + icon
            }

            if (gameTitleVisible && currentTournamentGameId && elements.headerGameTitle) {
                const gameName = appSettings?.games?.[currentTournamentGameId]?.name || `Game`;
                elements.headerGameTitle.textContent = gameName;
            }
            else if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; }
        }
        function updateGlobalUI(isLoggedIn) {
            if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; }
            if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
            if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
            elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; });
        }
        function populateUserInfo(user, profile) {
            if (!user || !profile) return;
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User';
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=70`;
            const balance = (profile.balance || 0); const winningCash = (profile.winningCash || 0); const bonusCash = (profile.bonusCash || 0);
            const totalEarnings = (profile.totalEarnings || 0); const referralEarnings = (profile.referralEarnings || 0);
            const totalMatches = profile.totalMatches || 0; const wonMatches = profile.wonMatches || 0;
            const formatCurrency = (amount) => `Rs${amount.toFixed(2)}`;
            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0];
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(balance);
            if (elements.walletTotalBalance) { elements.walletTotalBalance.textContent = formatCurrency(balance); removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow')); }
            if (elements.walletWinningCash) { elements.walletWinningCash.textContent = formatCurrency(winningCash); removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow')); }
            if (elements.walletBonusCash) { elements.walletBonusCash.textContent = formatCurrency(bonusCash); removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow')); }
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash);
            if (elements.convertWinningCashBalance) elements.convertWinningCashBalance.textContent = formatCurrency(winningCash); // New: Convert Winning Cash Modal
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL;
            if (elements.profileName) { elements.profileName.textContent = displayName; removePlaceholders(elements.profileName.closest('.placeholder-glow')); }
            if (elements.profileEmail) { elements.profileEmail.textContent = user.email || 'N/A'; removePlaceholders(elements.profileEmail.closest('.placeholder-glow')); }
            if (elements.profileTotalMatches) { elements.profileTotalMatches.textContent = totalMatches; removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow')); }
            if (elements.profileWonMatches) { elements.profileWonMatches.textContent = wonMatches; removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow')); }
            if (elements.profileTotalEarnings) { elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow')); }
            // Removed: if (elements.earningsTotal) { elements.earningsTotal.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.earningsTotal.closest('.placeholder-glow')); }
            // Removed: if (elements.earningsReferral) { elements.earningsReferral.textContent = formatCurrency(referralEarnings); removePlaceholders(elements.earningsReferral.closest('.placeholder-glow')); }
            if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
        }
        function toggleLoginForm(showLogin) {
            if (!elements.emailLoginForm || !elements.emailSignupForm) return;
            clearStatusMessage(elements.loginStatusMessage);
            clearStatusMessage(elements.signupStatusMessage);
            elements.emailLoginForm.style.display = showLogin ? 'block' : 'none';
            elements.emailSignupForm.style.display = showLogin ? 'none' : 'block';
            // Reset forms when toggling
            elements.emailLoginForm.reset();
            elements.emailSignupForm.reset();
        }

        // --- Firebase Auth Functions ---
        async function signUpWithEmail() {
            if (!auth) return;
            const displayName = elements.signupDisplayNameInput.value.trim(); // Get username
            const em = elements.signupEmailInput.value.trim();
            const pw = elements.signupPasswordInput.value;
            const cpw = elements.signupConfirmPasswordInput.value;
            const refCode = elements.signupReferralCodeInput.value.trim(); // <<< Get Referral Code

            if (!displayName || !em || !pw || !cpw) { showStatusMessage(elements.signupStatusMessage, 'Fill all required fields.', 'warning'); return; }
            if (pw !== cpw) { showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); return; }
            if (pw.length < 6) { showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); return; }

            showLoader(true); clearStatusMessage(elements.signupStatusMessage);
            validReferrerUid = null; // Reset potential referrer

            try {
                // --- Validate Referral Code (if provided) BEFORE creating user ---
                if (refCode) {
                    console.log("Validating referral code:", refCode);
                    const usersRef = ref(db, 'users');
                    // IMPORTANT: Requires index on "referralCode" in Firebase Rules for /users
                    // Ensure Firebase rules allow reading users node for this query (e.g., allow read if auth != null)
                    const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode));
                    const snapshot = await get(q);
                    if (snapshot.exists()) {
                        // Assuming only one user can have a specific referral code
                        const referrerData = snapshot.val();
                        const referrerId = Object.keys(referrerData)[0]; // Get the UID
                        const referrerProfile = referrerData[referrerId];

                        // Check if the referrer is not the user themselves (though unlikely at signup)
                        // and ensure the referrer profile exists properly
                        if (referrerId && referrerProfile.email) { // Basic check
                            validReferrerUid = referrerId;
                            console.log("Valid referrer found:", validReferrerUid);
                        } else {
                            console.warn("Referral code found, but referrer data invalid:", referrerData);
                            // Optionally inform the user the code was invalid
                            // showStatusMessage(elements.signupStatusMessage, 'Invalid referral code.', 'warning');
                        }
                    } else {
                        console.log("Referral code not found:", refCode);
                        // Optionally inform the user the code was invalid
                        // showStatusMessage(elements.signupStatusMessage, 'Referral code not found.', 'warning');
                    }
                }

                // --- Create the user ---
                const userCredential = await createUserWithEmailAndPassword(auth, em, pw);
                // Update user profile with display name
                await updateProfile(userCredential.user, { displayName: displayName });

                // Success: onAuthStateChanged will handle profile creation now, using validReferrerUid if set.

            } catch (e) {
                console.error("Signup Error:", e); let m = `Signup failed.`; switch (e.code) { case 'auth/email-already-in-use': m = 'Email already registered.'; break; case 'auth/weak-password': m = 'Password too weak.'; break; case 'auth/invalid-email': m = 'Invalid email.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.signupStatusMessage, m, 'danger');
            } finally {
                showLoader(false);
            }
        }
        async function loginWithEmail() {
            if (!auth) return;
            const em = elements.loginEmailInput.value.trim();
            const pw = elements.loginPasswordInput.value;
            if (!em || !pw) { showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); return; }
            showLoader(true); clearStatusMessage(elements.loginStatusMessage);
            try { await signInWithEmailAndPassword(auth, em, pw); }
            catch (e) { console.error("Login Error:", e); let m = `Login failed.`; switch (e.code) { case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break; case 'auth/invalid-email': m = 'Invalid email format.'; break; case 'auth/too-many-requests': m = 'Too many attempts. Reset pass or wait.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
            finally { showLoader(false); }
        }
        async function resetPassword() {
            if (!auth) return;
            const em = currentUser ? currentUser.email : elements.loginEmailInput.value.trim(); // Use current user's email if logged in
            if (!em) { showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning'); return; }
            showLoader(true); clearStatusMessage(elements.loginStatusMessage);
            try { await sendPasswordResetEmail(auth, em); showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false); }
            catch (e) { console.error("Reset Pass Error:", e); let m = `Failed to send email.`; switch (e.code) { case 'auth/user-not-found': case 'auth/invalid-email': m = 'Email not found.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); }
            finally { showLoader(false); }
        }
        async function logoutUser() { if (!auth) return; try { showLoader(true); await signOut(auth); } catch (e) { console.error("Sign Out Error:", e); alert(`Logout failed: ${e.message}`); showLoader(false); } }

        // --- Auth State Change Handler --- [UPDATED FOR REFERRAL]
        async function handleAuthStateChange(user) {
            if (!auth || !db) { console.error("Firebase not ready in auth change"); showLoader(false); return; }
            showLoader(true); detachAllDbListeners(); currentUser = user;
            const localReferrerUid = validReferrerUid; // Capture the value before resetting
            validReferrerUid = null; // Reset for next signup attempt

            if (user) { // Logged In
                console.log("Auth State: Logged In", user.uid); const userRef = ref(db, 'users/' + user.uid);
                try {
                    const snapshot = await get(userRef);
                    if (snapshot.exists()) { // Existing user
                        userProfile = snapshot.val(); const updates = {};
                        // Update displayName if Firebase Auth displayName is different or not set in DB
                        if (user.displayName && (!userProfile.displayName || userProfile.displayName !== user.displayName)) updates.displayName = user.displayName;
                        if (user.email && !userProfile.email) updates.email = user.email;
                        if (Object.keys(updates).length > 0) { await update(userRef, updates); userProfile = { ...userProfile, ...updates }; }
                    } else { // New user
                        console.log("New user, creating profile...");
                        const newUserProfile = {
                            uid: user.uid, displayName: user.displayName || user.email?.split('@')[0] || 'User', email: user.email || null, photoURL: user.photoURL || null,
                            balance: appSettings.newUserBalance || 0, winningCash: 0, bonusCash: appSettings.newUserBonus || 0,
                            totalMatches: 0, wonMatches: 0, totalEarnings: 0, referralEarnings: 0, createdAt: Date.now(),
                            referralCode: generateReferralCode(), joinedTournaments: {}, isAdmin: false,
                            customRooms: {}, // New: Initialize customRooms for new users
                            // <<< Add referredBy field if valid referrer was found during signup >>>
                            ...(localReferrerUid && { referredBy: localReferrerUid })
                        };
                        await set(userRef, newUserProfile);
                        userProfile = newUserProfile;

                        // Award signup bonus to new user (if any)
                        if (newUserProfile.bonusCash > 0) {
                            await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`);
                        }

                        // --- Award bonus to referrer (if any) ---
                        if (localReferrerUid && appSettings.referralBonus > 0) {
                            console.log(`Awarding referral bonus of ${appSettings.referralBonus} to referrer: ${localReferrerUid}`);
                            const referrerRef = ref(db, `users/${localReferrerUid}`);
                            try {
                                const referrerUpdateResult = await runTransaction(referrerRef, (referrerData) => {
                                    if (referrerData) {
                                        referrerData.balance = (referrerData.balance || 0) + appSettings.referralBonus;
                                        referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus; // Or winningCash depending on rules
                                        referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus;
                                    }
                                    return referrerData;
                                });

                                if (referrerUpdateResult.committed) {
                                    await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`);
                                    console.log("Referrer bonus awarded successfully.");
                                } else {
                                    console.error("Referrer bonus transaction aborted.");
                                }
                            } catch (referrerError) {
                                console.error("Error awarding referrer bonus:", referrerError);
                            }
                        }
                        // --- End Referrer Bonus Award ---
                    }
                    populateUserInfo(user, userProfile); setupRealtimeListeners(user.uid); updateGlobalUI(true);
                    const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                    showSection(targetSection);
                } catch (error) { console.error("Profile handling error:", error); alert("Error loading profile. Logging out. " + error.message); try { await logoutUser(); } catch (logoutErr) { } }
            } else { // Logged Out
                console.log("Auth State: Logged Out"); currentUser = null; userProfile = {}; updateGlobalUI(false); showSection('login-section');
            }
            showLoader(false);
        }

        // --- Database Interaction Functions ---

        // *** MODIFIED: loadAppSettings switched from get() to onValue() for real-time updates ***
        function loadAppSettings() {
            console.log("Attaching listener for App Settings...");
            const settingsRef = ref(db, 'settings');

            // Detach any previous listener to avoid duplicates
            if (dbListeners['settings']) {
                off(settingsRef, 'value', dbListeners['settings'].func);
                delete dbListeners['settings'];
            }

            const settingsListener = onValue(settingsRef, (snapshot) => {
                if (snapshot.exists()) {
                    appSettings = snapshot.val() || {};
                    console.log("App Settings Updated (Real-time):", appSettings);

                    // Apply theme from settings
                    applyTheme(appSettings.theme || null);

                    // Apply other settings to UI
                    if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl;
                    if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw;

                    // Update modal content dynamically based on settings
                    // This part is now handled by the showPaymentMethodDetails function
                    // const upiIdEl = document.querySelector('.Khalti-number');
                    // if (upiIdEl) {
                    //     upiIdEl.textContent = appSettings.upiDetails || '[!!! YOUR Esewa ID/NUMBER HERE !!!]'; // Use setting or keep placeholder
                    // }
                    // Update max rooms allowed text
                    if (elements.maxRoomsAllowedEl) {
                        elements.maxRoomsAllowedEl.textContent = appSettings.maxCustomRooms || MAX_CUSTOM_ROOMS;
                    }
                    if (elements.roomCreationFeeEl) {
                        elements.roomCreationFeeEl.textContent = appSettings.roomCreationFee || ROOM_CREATION_FEE;
                    }

                    // --- Check for App Update ---
                    checkForAppUpdate();

                } else {
                    console.warn("App Settings not found in database! Using defaults.");
                    appSettings = {}; // Use defaults
                    applyTheme(null); // Reset to default theme if settings node is deleted

                    // Ensure placeholders remain in modals if settings are missing
                    // const upiIdEl = document.querySelector('.Khalti-number');
                    // if (upiIdEl) upiIdEl.textContent = '[!!! YOUR Esewa ID/NUMBER HERE !!!]';
                }
            }, (error) => {
                console.error("Settings listener failed", error);
                appSettings = {};
                applyTheme(null); // Reset to default on error
                // Optionally show a non-blocking warning
            });

            // Store the listener function so it can be detached later
            dbListeners['settings'] = { path: 'settings', func: settingsListener };
        }

        // --- App Update Logic ---
        function checkForAppUpdate() {
            const latestVersion = appSettings.latestAppVersion;
            const updateLink = appSettings.appUpdateLink;
            const forceUpdate = appSettings.forceUpdate || false; // New setting for mandatory update
            const whatsNew = appSettings.whatsNewContent || ''; // NEW: Get "What's New" content

            console.log(`Checking for app update. Current: ${CURRENT_APP_VERSION}, Latest: ${latestVersion}, Link: ${updateLink}, Force: ${forceUpdate}`);

            if (latestVersion && updateLink) {
                if (compareVersions(latestVersion, CURRENT_APP_VERSION) > 0) {
                    // A newer version is available
                    elements.currentAppVersionEl.textContent = CURRENT_APP_VERSION;
                    elements.newAppVersionEl.textContent = latestVersion;
                    elements.updateAppBtnEl.href = updateLink;

                    // NEW: Populate "What's New" content
                    if (elements.whatsNewContent) {
                        if (whatsNew) {
                            elements.whatsNewContent.innerHTML = whatsNew.replace(/\n/g, '<br>'); // Replace newlines with <br> for display
                            elements.whatsNewContainer.style.display = 'block';
                        } else {
                            elements.whatsNewContent.innerHTML = 'No new features listed.';
                            elements.whatsNewContainer.style.display = 'block'; // Still show the section, but with a message
                        }
                    }

                    if (forceUpdate) {
                        // Make the modal non-dismissible
                        elements.appUpdateModalInstance._config.backdrop = 'static';
                        elements.appUpdateModalInstance._config.keyboard = false;
                        if (elements.remindMeLaterBtnEl) elements.remindMeLaterBtnEl.style.display = 'none';
                    } else {
                        // Allow dismissing
                        elements.appUpdateModalInstance._config.backdrop = true;
                        elements.appUpdateModalInstance._config.keyboard = true;
                        if (elements.remindMeLaterBtnEl) elements.remindMeLaterBtn.style.display = 'inline-block';
                    }

                    elements.appUpdateModalInstance.show();
                } else {
                    // Current version is up-to-date or newer than latest (shouldn't happen often)
                    elements.appUpdateModalInstance.hide();
                }
            } else {
                // No update information provided by admin
                elements.appUpdateModalInstance.hide();
            }
        }


        function loadHomePageData() {
            console.log("Loading Home Page Data...");
            if (!currentUser) {
                console.log("User not logged in, skipping home data load.");
                if (elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = '';
                if (elements.gamesList) elements.gamesList.innerHTML = '';
                if (elements.myContestsList) elements.myContestsList.innerHTML = '<p class="text-secondary text-center">Login to view contests.</p>';
                return;
            }
            loadPromotions();
            loadGames();
            loadMyContests();
        }

        async function loadPromotions() {
            console.log("Loading Promotions...");
            if (!elements.promotionSlider) return;
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper');
            if (!sliderWrapper) return;
            sliderWrapper.classList.add('placeholder-glow');
            sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="height: 100%; border-radius: 10px; display: block; width: 100%;"></span></div>`;

            const promoRef = ref(db, 'promotions');
            try {
                const snapshot = await get(promoRef);
                const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p.imageUrl); // Filter only those with imageUrl
                console.log(`Found ${activePromotions.length} active promotions.`);

                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = ''; // Clear placeholders

                if (activePromotions.length > 0) {
                    elements.promotionSlider.style.display = 'block';
                    activePromotions.forEach(promo => {
                        const slide = document.createElement('div');
                        slide.className = 'swiper-slide';
                        slide.innerHTML = promo.link ? `<a href="${promo.link}" target="_blank"><img src="${promo.link}" alt="Promo"></a>` : `<img src="${promo.imageUrl}" alt="Promo">`;
                        sliderWrapper.appendChild(slide);
                    });
                    if (swiperInstance) swiperInstance.destroy(true, true);
                    swiperInstance = new Swiper(elements.promotionSlider, {
                        loop: activePromotions.length > 1,
                        autoplay: { delay: 3500, disableOnInteraction: false },
                        pagination: { el: '.swiper-pagination', clickable: true },
                        slidesPerView: 1
                    });
                } else {
                    elements.promotionSlider.style.display = 'none';
                }
            } catch (e) {
                console.error("Promo load failed:", e);
                removePlaceholders(elements.promotionSlider);
                sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>';
                elements.promotionSlider.style.display = 'block';
            }
        }

        async function loadGames() {
            console.log("Loading Games...");
            if (!elements.gamesList) return;
            elements.gamesList.classList.add('placeholder-glow');
            elements.gamesList.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`;

            const gamesRef = ref(db, 'games');
            try {
                const snapshot = await get(gamesRef);
                const games = snapshot.val() || {};
                const activeGames = Object.entries(games)
                    .filter(([, game]) => game.imageUrl && game.name)
                    .sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
                console.log(`Found ${activeGames.length} active games.`);

                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = ''; // Clear placeholders

                if (activeGames.length > 0) {
                    if (!appSettings.games) appSettings.games = {};
                    elements.roomGameIdInput.innerHTML = '<option value="">Select a Game</option>'; // Clear and add default for create room modal
                    activeGames.forEach(([gameId, game]) => {
                        appSettings.games[gameId] = { name: game.name, imageUrl: game.imageUrl }; // Store imageUrl too
                        const col = document.createElement('div');
                        col.className = 'col-6';
                        col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}"><img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`;
                        col.querySelector('.game-card').addEventListener('click', () => {
                            currentTournamentGameId = gameId;
                            loadTournamentsForGame(gameId, game.name);
                        });
                        elements.gamesList.appendChild(col);

                        // Populate game options for create room modal
                        const option = document.createElement('option');
                        option.value = gameId;
                        option.textContent = game.name;
                        elements.roomGameIdInput.appendChild(option);
                    });
                } else {
                    elements.gamesList.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>';
                    elements.roomGameIdInput.innerHTML = '<option value="">No Games Available</option>';
                }
            } catch (e) {
                console.error("Games load failed:", e);
                removePlaceholders(elements.gamesList);
                elements.gamesList.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>';
                elements.roomGameIdInput.innerHTML = '<option value="">Error loading games</option>';
            }
        }

        function loadTournamentsForGame(gameId, gameName) {
            console.log(`Loading tournaments for game: ${gameName} (ID: ${gameId})`);
            if (!elements.tournamentsSection) return;
            currentTournamentGameId = gameId;
            elements.tournamentTabs.forEach(t => t.classList.remove('active'));
            querySel('.tournament-tabs .tab-item[data-status="upcoming"][data-type="regular"]')?.classList.add('active');
            showSection('tournaments-section'); // This will call filterTournaments
            filterTournaments(gameId, 'upcoming', 'regular');
        }

        async function filterTournaments(gameId, status, type) {
            console.log(`Filtering tournaments for game ${gameId} with status ${status} and type ${type}`);
            if (!elements.tournamentsListContainer) return;
            elements.tournamentsListContainer.innerHTML = ''; // Clear previous list
            elements.tournamentsListContainer.classList.add('placeholder-glow');
            elements.tournamentsListContainer.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"><span class="placeholder col-4 h-30"></span><span class="placeholder col-4 h-30"></span></div></div>`; // Show placeholders
            elements.noTournamentsMessage.style.display = 'none'; // Hide 'no tournaments' message
            try {
                let dataRef;
                let allT;

                if (type === 'regular') {
                    dataRef = ref(db, 'tournaments');
                    const tQuery = query(dataRef, orderByChild('gameId'), equalTo(gameId));
                    const s = await get(tQuery);
                    allT = s.val() || {};
                    const fT = Object.entries(allT)
                        .filter(([, t]) => t.status === status)
                        .sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0));
                    console.log(`Found ${fT.length} regular tournaments matching criteria.`);

                    removePlaceholders(elements.tournamentsListContainer);
                    elements.tournamentsListContainer.innerHTML = ''; // Clear placeholders again

                    if (fT.length > 0) {
                        fT.forEach(([tId, t]) => {
                            const card = createTournamentCardElement(tId, t, gameId, false); // Pass gameId and isCustomRoom=false
                            elements.tournamentsListContainer.appendChild(card);
                        });
                    } else {
                        elements.noTournamentsMessage.style.display = 'block';
                        elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`;
                    }
                } else if (type === 'custom') {
                    // For custom rooms, we want to show all custom rooms for the selected game
                    dataRef = ref(db, 'customRooms');
                    const cQuery = query(dataRef, orderByChild('gameId'), equalTo(gameId));
                    const s = await get(cQuery);
                    allT = s.val() || {};
                    // Filter by status if needed, but for "Custom Rooms" tab, usually show all active
                    const fT = Object.entries(allT)
                        .filter(([, t]) => t.status === 'upcoming' || t.status === 'ongoing') // Show only upcoming/ongoing custom rooms
                        .sort(([, tA], [, tB]) => (tA.createdAt || 0) - (tB.createdAt || 0)); // Sort by creation time
                    console.log(`Found ${fT.length} custom rooms matching criteria.`);

                    removePlaceholders(elements.tournamentsListContainer);
                    elements.tournamentsListContainer.innerHTML = ''; // Clear placeholders again

                    if (fT.length > 0) {
                        fT.forEach(([tId, t]) => {
                            const card = createTournamentCardElement(tId, t, gameId, true); // Pass gameId and isCustomRoom=true
                            elements.tournamentsListContainer.appendChild(card);
                        });
                    } else {
                        elements.noTournamentsMessage.style.display = 'block';
                        elements.noTournamentsMessage.textContent = `No custom rooms found for this game.`;
                    }
                }


            } catch (e) {
                console.error(`Tournaments filter failed (${status}, ${type}):`, e);
                removePlaceholders(elements.tournamentsListContainer);
                elements.tournamentsListContainer.innerHTML = '<p class="text-danger tc mt-4">Could not load tournaments.</p>';
                elements.noTournamentsMessage.style.display = 'none';
            }
        }

        function createTournamentCardElement(tId, t, gameId, isCustomRoom = false) { // Added gameId parameter and isCustomRoom
            const card = document.createElement('div'); card.className = 'tournament-card'; card.dataset.tournamentId = tId;
            const eFee = t.entryFee || 0; const pkPrize = t.perKillPrize || 0; const pPool = t.prizePool || 0;
            const sTime = t.startTime ? new Date(t.startTime) : (t.createdAt ? new Date(t.createdAt) : null); // Use createdAt for custom rooms if startTime is null
            const sTimeLoc = sTime ? sTime.toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA';
            const regP = t.registeredPlayers || {}; const regC = Object.keys(regP).length; const maxP = t.maxPlayers || 0;

            //console.log(`Creating card for tId: ${tId}, Status: ${t.status}, Registered Count (regC): ${regC}, Max Players: ${maxP}`); // <<< Log spot count

            const spotsL = maxP > 0 ? Math.max(0, maxP - regC) : Infinity; const isF = maxP > 0 && spotsL <= 0;
            const isJ = currentUser && userProfile?.joinedTournaments?.[tId];
            const canJ = !isJ && !isF && t.status === 'upcoming'; let timerTxt = t.status?.toUpperCase() || 'N/A';
            if (t.status === 'upcoming' && sTime) timerTxt = getTimeRemaining(t.startTime || t.createdAt); else if (t.status === 'ongoing') timerTxt = 'LIVE'; else if (t.status === 'completed' || t.status === 'result') timerTxt = 'ENDED';
            let spotsTxt = 'Unlimited Spots'; let progP = 0; if (maxP > 0) { spotsTxt = `<span class="${spotsL <= 5 ? 'text-danger' : 'text-accent'}">${spotsL}</span> Spots Left (${regC}/${maxP})`; progP = Math.min(100, (regC / maxP) * 100); }
            let actBtn = ''; let idPassBtn = '';
            if (isCustomRoom) {
                // For custom rooms, creator can delete or edit, others can join
                if (currentUser && userProfile.uid === t.creatorUid) {
                    idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}" data-is-custom-room="true"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                    actBtn = `<button class="btn btn-custom btn-sm btn-custom-secondary btn-edit-room" data-tournament-id="${tId}"><i class="bi bi-pencil-square"></i> Edit Room</button>
                              <button class="btn btn-custom btn-sm btn-danger mt-2 btn-delete-room" data-tournament-id="${tId}"><i class="bi bi-trash"></i> Delete Room</button>`;
                } else {
                    // Other users can join custom rooms
                    if (isJ) {
                        actBtn = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
                        // Show ID/Pass if room is ongoing or within 5 mins of creation time
                        if (t.status === 'ongoing' || (t.status === 'upcoming' && sTime && Date.now() > sTime.getTime() - (5 * 60 * 1000))) { // 5 minutes before creation time
                            idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}" data-is-custom-room="true"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                        }
                    } else if (canJ) {
                        actBtn = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}" data-is-custom-room="true">Rs${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
                    } else {
                        let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                        actBtn = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`;
                    }
                }
            } else {
                // For regular tournaments
                if (isJ) {
                    actBtn = `<button class="btn btn-custom btn-sm btn-joined" disabled><i class="bi bi-check-circle-fill"></i> Joined</button>`;
                    if (t.status === 'ongoing' || (t.status === 'upcoming' && t.showIdPass && sTime && Date.now() > sTime.getTime() - 900000)) {
                        idPassBtn = `<button class="btn btn-custom btn-idpass w-100 mt-2 btn-sm" data-tournament-id="${tId}"><i class="bi bi-key-fill"></i> View ID & Pass</button>`;
                    }
                } else if (canJ) {
                    actBtn = `<button class="btn btn-custom btn-sm btn-custom-accent btn-join" data-tournament-id="${tId}" data-fee="${eFee}">Rs${eFee} Join <i class="bi bi-arrow-right-short"></i></button>`;
                } else {
                    let disR = t.status !== 'upcoming' ? t.status?.toUpperCase() : (isF ? 'Full' : 'Closed');
                    actBtn = `<button class="btn btn-custom btn-sm btn-disabled" disabled>${disR || 'N/A'}</button>`;
                }
            }


            // Get game image URL
            const gameImageUrl = appSettings.games?.[gameId]?.imageUrl || 'https://via.placeholder.com/50';
            const gameName = appSettings.games?.[gameId]?.name || 'Game';

            // Determine prize distribution text
            let prizeDistributionText = '';
            if (t.prizeDistribution) {
                if (typeof t.prizeDistribution === 'object') {
                    const ranks = Object.keys(t.prizeDistribution).sort((a, b) => parseInt(a.replace('Rank ', '')) - parseInt(b.replace('Rank ', '')));
                    if (ranks.length > 0) {
                        prizeDistributionText = 'Rewards: ';
                        ranks.forEach((rank, index) => {
                            prizeDistributionText += `${rank}: Rs${t.prizeDistribution[rank]}`;
                            if (index < ranks.length - 1) {
                                prizeDistributionText += ', ';
                            }
                        });
                    }
                } else {
                    prizeDistributionText = `Prize: Rs${pPool}`; // Fallback if not an object
                }
            } else {
                prizeDistributionText = `Prize: Rs${pPool}`;
            }


            card.innerHTML = `<div class="tournament-card-header"><div class="tournament-card-tags">${t.mode ? `<span>${t.mode}</span>` : ''}${t.map ? `<span>${t.map}</span>` : ''}${t.tags ? (Array.isArray(t.tags) ? t.tags.map(tag => `<span>${tag}</span>`).join('') : Object.values(t.tags).map(tag => `<span>${tag}</span>`).join('')) : ''}</div><div class="tournament-card-timer">${timerTxt}</div></div>
            <h3 class="tournament-card-title">
                <img src="${gameImageUrl}" alt="${gameName}" class="tournament-game-icon">
                ${t.icon ? `<i class="${t.icon}"></i>` : ''} ${t.name || 'Tournament'}
            </h3>
            <p class="small text-secondary mb-2"><i class="bi bi-calendar-event"></i> ${sTimeLoc}</p><div class="tournament-card-info"><div class="info-item"><span>Prize Pool</span><strong><i class="bi bi-trophy-fill text-accent prize-icon"></i> ${prizeDistributionText}</strong></div><div class="info-item"><span>Per Kill</span><strong>Rs${pkPrize}</strong></div><div class="info-item"><span>Entry Fee</span><strong class="${eFee > 0 ? 'text-info' : ''}">${eFee > 0 ? `Rs${eFee}` : 'Free'}</strong></div></div><div class="tournament-card-spots">${spotsTxt}${maxP > 0 ? `<div class="progress mt-1" style="height: 6px;"><div class="progress-bar bg-warning" role="progressbar" style="width: ${progP}%"></div></div>` : ''}</div><div class="tournament-card-actions"><button class="btn btn-custom btn-custom-secondary btn-sm btn-details" data-tournament-id="${tId}" data-is-custom-room="${isCustomRoom}">Details</button>${actBtn}</div>${idPassBtn}`;
            const jBtn = card.querySelector('.btn-join'); if (jBtn) jBtn.addEventListener('click', handleJoinTournamentClick);
            const dBtn = card.querySelector('.btn-details'); if (dBtn) dBtn.addEventListener('click', handleMatchDetailsClick);
            const ipBtn = card.querySelector('.btn-idpass'); if (ipBtn) ipBtn.addEventListener('click', handleIdPasswordClick);
            const delBtn = card.querySelector('.btn-delete-room'); if (delBtn) delBtn.addEventListener('click', handleDeleteRoomClick); // New: Delete Room Button
            const editBtn = card.querySelector('.btn-edit-room'); if (editBtn) editBtn.addEventListener('click', handleEditRoomClick); // NEW: Edit Room Button
            return card;
        }

        async function loadMyContests() {
            console.log("Loading My Contests...");
            if (!currentUser || !elements.myContestsList) { if (elements.myContestsList) removePlaceholders(elements.myContestsList); if (elements.myContestsList) elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; return; }
            const joinedIds = Object.keys(userProfile.joinedTournaments || {});
            elements.myContestsList.classList.add('placeholder-glow');
            elements.myContestsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"><span class="placeholder col-6"></span><span class="placeholder col-12 mt-2"></span><span class="placeholder col-10 mt-2"></span><div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4 h-30"></span> <span class="placeholder col-4 h-30"></span> </div></div>`; // Placeholder
            if (elements.noContestsMessage) { elements.noContestsMessage.style.display = 'none'; }
            if (joinedIds.length === 0) { removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = ''; if (elements.noContestsMessage) elements.noContestsMessage.style.display = 'block'; console.log("No joined contests found for user."); return; }
            console.log(`Found ${joinedIds.length} joined contest IDs.`);
            try {
                const contestPromises = joinedIds.map(id => get(ref(db, `tournaments/${id}`)));
                const snapshots = await Promise.all(contestPromises);
                removePlaceholders(elements.myContestsList);
                elements.myContestsList.innerHTML = ''; // Clear placeholders
                const contestCards = [];
                for (const snapshot of snapshots) {
                    if (snapshot.exists()) {
                        const t = snapshot.val();
                        const tId = snapshot.key; // Get the actual key from snapshot
                        // Determine if it's a regular tournament or custom room
                        const isCustom = t.creatorUid ? true : false; // Simple check for custom room
                        // Filter to show only upcoming or ongoing in "My Contests"
                        if (t.status === 'upcoming' || t.status === 'ongoing') {
                            contestCards.push({ startTime: t.startTime || t.createdAt || 0, card: createTournamentCardElement(tId, t, t.gameId, isCustom) });
                        }
                    } else {
                        console.warn(`Joined tournament ${snapshot.key} not found in tournaments node.`);
                        // Optionally remove the invalid entry from user's profile here
                        // update(ref(db, `users/${currentUser.uid}/joinedTournaments/${joinedIds[index]}`), null);
                    }
                }
                contestCards.sort((a, b) => a.startTime - b.startTime); // Sort by start time
                if (contestCards.length > 0) {
                    contestCards.forEach(item => elements.myContestsList.appendChild(item.card));
                } else if (elements.noContestsMessage) {
                    elements.noContestsMessage.style.display = 'block';
                    elements.noContestsMessage.textContent = "No upcoming/ongoing joined contests.";
                }
            } catch (e) { console.error("My contests load failed:", e); removePlaceholders(elements.myContestsList); elements.myContestsList.innerHTML = '<p class="text-danger tc">Could not load contests.</p>'; }
        }

        // New: loadMyCustomRooms function (MODIFIED TO SHOW ALL ROOMS)
        async function loadMyCustomRooms() {
            console.log("Loading All Custom Rooms...");
            if (!currentUser || !elements.myCustomRoomsList) {
                if (elements.myCustomRoomsList) removePlaceholders(elements.myCustomRoomsList);
                if (elements.myCustomRoomsList) elements.myCustomRoomsList.innerHTML = '';
                if (elements.noCustomRoomsMessage) elements.noCustomRoomsMessage.style.display = 'block';
                return;
            }

            elements.myCustomRoomsList.classList.add('placeholder-glow');
            elements.myCustomRoomsList.innerHTML = `<div class="tournament-card placeholder-glow mb-3"> <span class="placeholder col-6"></span> <span class="placeholder col-12 mt-2"></span> <span class="placeholder col-10 mt-2"></span> <div class="d-flex justify-content-between mt-3"> <span class="placeholder col-4 h-30"></span> <span class="placeholder col-4 h-30"></span> </div></div>`; // Placeholder
            if (elements.noCustomRoomsMessage) { elements.noCustomRoomsMessage.style.display = 'none'; }

            try {
                const roomsRef = ref(db, 'customRooms');
                const snapshot = await get(roomsRef);
                const allRooms = snapshot.val() || {};

                removePlaceholders(elements.myCustomRoomsList);
                elements.myCustomRoomsList.innerHTML = ''; // Clear placeholders

                const roomCards = [];
                Object.entries(allRooms).forEach(([roomId, room]) => {
                    // Only show upcoming or ongoing rooms
                    if (room.status === 'upcoming' || room.status === 'ongoing') {
                        roomCards.push({ createdAt: room.createdAt || 0, card: createTournamentCardElement(roomId, room, room.gameId, true) }); // Pass isCustomRoom=true
                    }
                });

                roomCards.sort((a, b) => b.createdAt - a.createdAt); // Sort by creation time (newest first)
                if (roomCards.length > 0) {
                    roomCards.forEach(item => elements.myCustomRoomsList.appendChild(item.card));
                } else if (elements.noCustomRoomsMessage) {
                    elements.noCustomRoomsMessage.style.display = 'block';
                    elements.noCustomRoomsMessage.textContent = "No custom rooms available. Be the first to create one!";
                }
            } catch (e) {
                console.error("All custom rooms load failed:", e);
                removePlaceholders(elements.myCustomRoomsList);
                elements.myCustomRoomsList.innerHTML = '<p class="text-danger tc">Could not load custom rooms.</p>';
            }
        }


        // New: loadRankData function
        async function loadRankData() {
            console.log("Loading Rank Data...");
            if (!elements.rankList) return;

            elements.rankList.innerHTML = ''; // Clear previous list
            elements.rankList.classList.add('placeholder-glow');
            elements.rankList.innerHTML = `
                <div class="list-group-item placeholder-glow">
                    <span class="placeholder col-1" style="height: 20px;"></span>
                    <div class="rank-info">
                        <span class="placeholder rank-avatar" style="width: 40px; height: 40px; border-radius: 50%;"></span>
                        <span class="placeholder col-6" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>
                <div class="list-group-item placeholder-glow">
                    <span class="placeholder col-1" style="height: 20px;"></span>
                    <div class="rank-info">
                        <span class="placeholder rank-avatar" style="width: 40px; height: 40px; border-radius: 50%;"></span>
                        <span class="placeholder col-6" style="height: 20px;"></span>
                    </div>
                    <span class="placeholder col-3" style="height: 20px;"></span>
                </div>
            `; // Show placeholders
            elements.noRankDataMessage.style.display = 'none'; // Hide 'no rank data' message initially

            try {
                const usersRef = ref(db, 'users');
                const snapshot = await get(usersRef);
                const users = snapshot.val() || {};

                const rankedUsers = Object.values(users)
                    .filter(user => typeof user.totalEarnings === 'number') // Ensure totalEarnings is a number
                    .sort((a, b) => b.totalEarnings - a.totalEarnings); // Sort by totalEarnings descending

                removePlaceholders(elements.rankList);
                elements.rankList.innerHTML = ''; // Clear placeholders

                if (rankedUsers.length > 0) {
                    rankedUsers.forEach((user, index) => {
                        const listItem = document.createElement('div');
                        listItem.className = 'list-group-item';
                        const displayName = user.displayName || user.email?.split('@')[0] || 'User';
                        const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=0F172A&color=E2E8F0&bold=true&size=40`;

                        listItem.innerHTML = `
                            <span class="rank-number">${index + 1}</span>
                            <div class="rank-info">
                                <img src="${photoURL}" alt="Avatar" class="rank-avatar">
                                <span class="rank-name">${displayName}</span>
                            </div>
                            <span class="rank-earnings">Rs${(user.totalEarnings || 100).toFixed(2)}</span>
                        `;
                        elements.rankList.appendChild(listItem);
                    });
                } else {
                    elements.noRankDataMessage.style.display = 'block';
                }

            } catch (e) {
                console.error("Error loading rank data:", e);
                removePlaceholders(elements.rankList);
                elements.rankList.innerHTML = '<p class="text-danger text-center col-12">Could not load rank data.</p>';
                elements.noRankDataMessage.style.display = 'none';
            }
        }


        function loadWalletData() {
            console.log("Loading Wallet Data...");
            if (!currentUser) return;
            loadRecentTransactions();
            // Balance display is handled by populateUserInfo via the realtime listener
        }
        function loadProfileData() {
            console.log("Loading Profile Data...");
            if (!currentUser) return;
            // Profile header data is handled by populateUserInfo via the realtime listener
            // Ensure placeholders are removed if data already exists
            if (userProfile?.displayName) { removePlaceholders(elements.profileName?.closest('.placeholder-glow')); removePlaceholders(elements.profileEmail?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow')); }
        }
        // Removed: loadEarningsData function
        // function loadEarningsData() {
        //     console.log("Loading Earnings Data...");
        //     if (!currentUser) return;
        //     // Earnings data is handled by populateUserInfo via the realtime listener
        //     if (typeof userProfile?.totalEarnings !== 'undefined') removePlaceholders(elements.earningsTotal?.closest('.placeholder-glow'));
        //     if (typeof userProfile?.referralEarnings !== 'undefined') removePlaceholders(elements.earningsReferral?.closest('.placeholder-glow'));
        // }

        async function recordTransaction(userId, type, amount, description, details = {}) {
            if (!userId) return;
            const transactionRef = ref(db, `transactions/${userId}`);
            const newTransaction = { type, amount, description, timestamp: Date.now(), ...details }; // Use client time for simplicity here
            try {
                await push(transactionRef, newTransaction);
                console.log(`Transaction recorded: ${type}, Amount: ${amount}`);
            } catch (e) {
                console.error("Transaction record failed:", e);
            }
        }

        async function loadRecentTransactions() {
            console.log("Loading Recent Transactions...");
            if (!currentUser || !elements.recentTransactionsList) return; const limit = 5;
            elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow');
            for (let i = 0; i < 3; i++) elements.recentTransactionsList.innerHTML += `<div class="custom-card p-2 mb-2 placeholder-glow"><div class="d-flex justify-content-between"><span class="placeholder col-5 h-16"></span><span class="placeholder col-3 h-16"></span></div><div class="small text-secondary mt-1"><span class="placeholder col-6 h-14"></span></div></div>`; // Placeholders
            if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; }
            try {
                const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit));
                const s = await get(transRef);
                const transactions = s.val() || {};
                const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                console.log(`Found ${sortedT.length} recent transactions.`);

                removePlaceholders(elements.recentTransactionsList);
                elements.recentTransactionsList.innerHTML = ''; // Clear placeholders

                if (sortedT.length > 0) {
                    if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';
                    sortedT.forEach(t => { const item = document.createElement('div'); item.className = 'custom-card p-2 mb-2 d-flex justify-content-between align-items-center'; const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}Rs${Math.abs(t.amount || 0).toFixed(2)}`; const time = t.timestamp ? new Date(t.timestamp).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'N/A'; item.innerHTML = `<div><div class="small fw-bold">${t.description || t.type || 'Txn'}</div><div class="small text-secondary">${time}</div></div><div class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">${amt}</div>`; elements.recentTransactionsList.appendChild(item); });
                } else if (elements.noTransactionsMessage) {
                    elements.noTransactionsMessage.style.display = 'block';
                    elements.noTransactionsMessage.textContent = 'No recent transactions.';
                }
            } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger tc">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; }
        }

        // Modified handleJoinTournamentClick to show game details modal
        async function handleJoinTournamentClick(event) {
            if (!currentUser) { alert("Login to join."); showSection('login-section'); return; }
            const btn = event.currentTarget;
            const tId = btn.dataset.tournamentId;
            const fee = parseFloat(btn.dataset.fee || 0);
            const isCustomRoom = btn.dataset.isCustomRoom === 'true'; // Check if it's a custom room

            if (!tId) return;

            // Check if it's a 4v4 custom room and if the user is the leader
            if (isCustomRoom) {
                const roomRef = ref(db, `customRooms/${tId}`);
                const roomSnapshot = await get(roomRef);
                if (roomSnapshot.exists()) {
                    const roomData = roomSnapshot.val();
                    if (roomData.mode === '4v4' && roomData.maxPlayers === 2) { // Assuming 8 players for 4v4 (2 teams of 4)
                        if (roomData.creatorUid !== currentUser.uid) {
                            alert("Only the room creator (leader) can join this 4v4 custom room.");
                            return;
                        }
                    }
                }
            }

            // Store the data needed for joining after game details are collected
            pendingJoinTournamentData = { tId, fee, btn, isCustomRoom };

            // Pre-fill if user has previously entered game details
            elements.gameUidInput.value = userProfile.gameUid || '';
            elements.gameNameInput.value = userProfile.gameName || '';
            clearStatusMessage(elements.gameDetailsStatusMessage);

            elements.gameDetailsModalInstance.show();
        }

        // New function to handle submission from the game details modal
        async function submitGameDetailsAndJoin() {
            if (!pendingJoinTournamentData) {
                console.error("No pending tournament join data.");
                return;
            }

            const { tId, fee, btn, isCustomRoom } = pendingJoinTournamentData;
            const gameUid = elements.gameUidInput.value.trim();
            const gameName = elements.gameNameInput.value.trim();

            if (!gameUid || !gameName) {
                showStatusMessage(elements.gameDetailsStatusMessage, 'Please enter both In-Game UID and In-Game Name.', 'warning');
                return;
            }

            elements.submitGameDetailsBtn.disabled = true;
            elements.submitGameDetailsBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';

            elements.gameDetailsModalInstance.hide(); // Hide the modal immediately

            // Re-enable the original join button and show spinner
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            }

            let transactionResult = null; // Store transaction result
            let tData = null; // To store tournament data

            try {
                // --- Step 0: Update user's profile with game details ---
                const userProfileUpdates = {};
                if (userProfile.gameUid !== gameUid) userProfileUpdates.gameUid = gameUid;
                if (userProfile.gameName !== gameName) userProfileUpdates.gameName = gameName;

                if (Object.keys(userProfileUpdates).length > 0) {
                    await update(ref(db, `users/${currentUser.uid}`), userProfileUpdates);
                    console.log("User game details updated.");
                    // Update local userProfile immediately
                    userProfile = { ...userProfile, ...userProfileUpdates };
                }

                // --- Step 1: Check Tournament Status & User Balance via Transaction ---
                const uRef = ref(db, `users/${currentUser.uid}`);
                const tournamentPath = isCustomRoom ? `customRooms/${tId}` : `tournaments/${tId}`;
                const tRef = ref(db, tournamentPath);

                transactionResult = await runTransaction(uRef, (profileData) => {
                    if (!profileData) throw new Error("User profile missing.");
                    if ((profileData.balance || 0) < fee) throw new Error("Insufficient balance.");
                    if (profileData.joinedTournaments?.[tId]) {
                        console.warn("Already joined (Tx check).");
                        return; // Abort transaction - user already joined
                    }
                    // Deduct balance - This will be committed ONLY IF transaction succeeds
                    profileData.balance = (profileData.balance || 0) - fee;
                    // *** Mark as joined LOCALLY within transaction data ***
                    if (!profileData.joinedTournaments) profileData.joinedTournaments = {};
                    profileData.joinedTournaments[tId] = { joinedAt: serverTimestamp(), gameUid: gameUid, gameName: gameName, isCustomRoom: isCustomRoom }; // Store game details and room type
                    return profileData; // Return modified profile to commit balance deduction
                });

                // --- Check if transaction was aborted because user was already joined ---
                if (!transactionResult.committed && userProfile?.joinedTournaments?.[tId]) {
                    console.log("Join aborted because user already joined.");
                    throw new Error("Already joined this tournament."); // Throw specific error
                } else if (!transactionResult.committed) {
                    throw new Error("Join transaction failed."); // Generic failure
                }

                console.log("Balance transaction successful.");

                // --- Step 2: Update Tournament Registered Players (if transaction committed) ---
                const snapshot = await get(tRef);
                if (!snapshot.exists()) throw new Error("Tournament not found after transaction.");
                tData = snapshot.val();
                if (tData.status !== 'upcoming') throw new Error("Tournament closed after balance check.");
                const rC = tData.registeredPlayers ? Object.keys(tData.registeredPlayers).length : 0;
                if (tData.maxPlayers > 0 && rC >= tData.maxPlayers) throw new Error("Tournament full after balance check.");

                // Prepare multi-path update for registeredPlayers, including game details
                const updates = {};
                updates[`${tournamentPath}/registeredPlayers/${currentUser.uid}`] = {
                    joinedAt: serverTimestamp(),
                    gameUid: gameUid,
                    gameName: gameName
                };

                console.log("Attempting to update registered players:", updates);
                await update(ref(db), updates); // Execute the update
                console.log("Successfully updated tournament registered players.");

                // --- Step 3: Record Transaction ---
                await recordTransaction(currentUser.uid, 'tournament_join', -fee, `Joined: ${tData.name || 'Tournament'}`, { tournamentId: tId, gameUid: gameUid, gameName: gameName, isCustomRoom: isCustomRoom });
                alert(`Joined! Rs${fee.toFixed(2)} deducted.`);

                // --- Step 4: Update UI ---
                // Fetch the absolute latest tournament data AFTER the update to ensure correct count
                const finalSnapshot = await get(tRef);
                if (finalSnapshot.exists()) {
                    const finalTData = finalSnapshot.val();
                    const cardEl = btn.closest('.tournament-card');
                    if (cardEl) {
                        cardEl.parentNode.replaceChild(createTournamentCardElement(tId, finalTData, finalTData.gameId, isCustomRoom), cardEl);
                    } else {
                        if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
                            const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                            const activeType = querySel('.tournament-tabs .tab-item.active')?.dataset.type || 'regular';
                            filterTournaments(currentTournamentGameId, activeTab, activeType);
                        }
                    }
                    if (currentSectionId === 'home-section') loadMyContests();
                } else {
                    console.warn("Tournament data missing after successful join update?");
                    if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
                        const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                        const activeType = querySel('.tournament-tabs .tab-item.active')?.dataset.type || 'regular';
                        filterTournaments(currentTournamentGameId, activeTab, activeType);
                    }
                    if (currentSectionId === 'home-section') loadMyContests();
                }
                if (currentSectionId === 'wallet-section') loadRecentTransactions();

            } catch (e) {
                console.error("Join failed:", e);
                alert(`Failed: ${e.message}`);
                // Re-enable the button if it's still present and the error wasn't "Already joined"
                if (btn && e.message !== "Already joined this tournament.") {
                    btn.disabled = false;
                    btn.innerHTML = `Rs${fee.toFixed(2)} Join <i class="bi bi-arrow-right-short"></i>`;
                }
                // If the error occurred AFTER balance deduction but BEFORE updating registered players,
                // attempt to refund the user.
                if (e.message !== "Insufficient balance." && e.message !== "User profile missing." && e.message !== "Already joined this tournament." && transactionResult?.committed) {
                    console.warn("Attempting to refund winning cash due to withdrawal request failure...");
                    try {
                        const refundTx = await runTransaction(uRef, (prof) => {
                            if (prof) {
                                prof.balance = (prof.balance || 0) + fee; // Add back total balance
                                // Remove the joined status added optimistically if necessary (or just check before adding)
                                if (prof.joinedTournaments && prof.joinedTournaments[tId]) {
                                    delete prof.joinedTournaments[tId];
                                    if (Object.keys(prof.joinedTournaments).length === 0) {
                                        prof.joinedTournaments = null; // Clean up if empty
                                    }
                                }
                            }
                            return prof;
                        });
                        if (refundTx.committed) {
                            await recordTransaction(currentUser.uid, 'join_failed_refund', fee, `Refund Failed Join: ${tData?.name || 'Tournament'}`);
                            alert("Join failed, but your balance was refunded.");
                        } else {
                            throw new Error("Refund transaction failed.");
                        }
                    } catch (refundError) {
                        console.error("CRITICAL: FAILED TO REFUND BALANCE!", refundError);
                        alert("Join failed. CRITICAL: Failed to refund balance (Rs${fee.toFixed(2)})! Contact support immediately.");
                    }
                }
            } finally {
                elements.submitGameDetailsBtn.disabled = false;
                elements.submitGameDetailsBtn.innerHTML = 'Submit & Join';
                pendingJoinTournamentData = null; // Clear pending data
            }
        }


        // --- Modal Handlers ---
        function handleWithdrawClick() {
            if (!currentUser || !elements.withdrawModalInstance) return;
            const wc = userProfile.winningCash || 0;
            const minW = appSettings?.minWithdraw || 50; // Use loaded setting or default
            elements.minWithdrawAmount.textContent = minW;
            elements.withdrawModalBalance.textContent = `Rs${wc.toFixed(2)}`;
            elements.withdrawAmountInput.value = '';
            elements.withdrawAmountInput.min = minW; // Set min attribute
            elements.withdrawMethodInput.value = userProfile.upiId || ''; // Pre-fill if available
            clearStatusMessage(elements.withdrawStatusMessage);
            elements.withdrawModalInstance.show();
        }

        async function submitWithdrawRequestHandler() {
            if (!currentUser || !elements.withdrawModalInstance) return;
            const amt = parseFloat(elements.withdrawAmountInput.value);
            const mtd = elements.withdrawMethodInput.value.trim();
            const wc = userProfile.winningCash || 0;
            const minW = appSettings?.minWithdraw || 50;
            clearStatusMessage(elements.withdrawStatusMessage);
            if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; }
            if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw Rs${minW}.`, 'warning'); return; }
            if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; }
            if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; }
            elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';
            let transactionCommitted = false; // Flag to check if balance was deducted
            try {
                const uRef = ref(db, `users/${currentUser.uid}`);
                // Step 1: Deduct winning cash via transaction
                const txResult = await runTransaction(uRef, (prof) => {
                    if (prof) {
                        if ((prof.winningCash || 0) >= amt) {
                            prof.winningCash = (prof.winningCash || 0) - amt;
                            // Note: Total balance is NOT reduced here, only winning cash.
                            // Admin reduces total balance upon APPROVAL.
                            return prof;
                        } else { throw new Error("Insufficient winning balance (Tx)."); }
                    } else { throw new Error("Profile missing (Tx)."); }
                });

                if (!txResult.committed) {
                    throw new Error("Failed to update balance. Please try again.");
                }
                transactionCommitted = true; // Mark balance as deducted
                console.log("Winning cash deducted successfully.");

                // Step 2: Create withdrawal request node
                const wrRef = ref(db, 'withdrawals');
                const newReq = {
                    userId: currentUser.uid,
                    userName: userProfile.displayName || currentUser.email,
                    amount: amt,
                    methodDetails: { // Store method details structured
                        methodName: mtd.includes('@') ? 'Esewa' : 'Bank/Other', // Simple guess
                        accountInfo: mtd
                    },
                    status: 'pending',
                    requestTimestamp: serverTimestamp(), // Use server time
                    userEmail: currentUser.email || 'N/A'
                };
                const newWithdrawalRef = await push(wrRef, newReq); // Get the new request ID
                console.log("Withdrawal request created:", newWithdrawalRef.key);

                // Step 3: Record transaction for the request
                await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key });

                showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false);
                setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500);
                if (currentSectionId === 'wallet-section') loadRecentTransactions();

            } catch (e) {
                console.error("Withdraw error:", e);
                showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger');
                // --- CRITICAL: Attempt to refund if balance was deducted but request failed ---
                if (transactionCommitted) {
                    console.warn("Attempting to refund winning cash due to withdrawal request failure...");
                    const uRef = ref(db, `users/${currentUser.uid}`);
                    try {
                        await runTransaction(uRef, (prof) => {
                            if (prof) {
                                prof.winningCash = (prof.winningCash || 0) + amt; // Add back
                            }
                            return prof;
                        });
                        await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`);
                        console.log("Refund successful.");
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger');
                    } catch (refundError) {
                        console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError);
                        showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support.`, 'danger', false);
                    }
                }
                // --- End Refund ---
            } finally {
                elements.submitWithdrawRequestBtn.disabled = false;
                elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request';
            }
        }

        // New: Handle Convert Winning Cash Click
        function handleConvertWinningCashClick() {
            if (!currentUser || !elements.convertWinningCashModalInstance) return;
            const wc = userProfile.winningCash || 0;
            elements.convertWinningCashBalance.textContent = `Rs${wc.toFixed(2)}`;
            elements.convertAmountInput.value = '';
            elements.convertAmountInput.max = wc; // Set max attribute
            clearStatusMessage(elements.convertWinningCashStatusMessage);
            elements.convertWinningCashModalInstance.show();
        }

        // New: Submit Convert Winning Cash Request
        async function submitConvertWinningCashRequest() {
            if (!currentUser || !elements.convertWinningCashModalInstance) return;
            const amt = parseFloat(elements.convertAmountInput.value);
            const wc = userProfile.winningCash || 0;
            clearStatusMessage(elements.convertWinningCashStatusMessage);

            if (isNaN(amt) || amt <= 0) {
                showStatusMessage(elements.convertWinningCashStatusMessage, 'Invalid amount.', 'warning');
                return;
            }
            if (amt > wc) {
                showStatusMessage(elements.convertWinningCashStatusMessage, 'Insufficient winning cash.', 'warning');
                return;
            }

            elements.submitConvertWinningCashBtn.disabled = true;
            elements.submitConvertWinningCashBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Converting...';

            try {
                const uRef = ref(db, `users/${currentUser.uid}`);
                const txResult = await runTransaction(uRef, (prof) => {
                    if (prof) {
                        if ((prof.winningCash || 0) >= amt) {
                            prof.winningCash = (prof.winningCash || 0) - amt;
                            prof.balance = (prof.balance || 0) + amt;
                            return prof;
                        } else {
                            throw new Error("Insufficient winning cash (Tx).");
                        }
                    } else {
                        throw new Error("Profile missing (Tx).");
                    }
                });

                if (!txResult.committed) {
                    throw new Error("Failed to convert cash. Please try again.");
                }

                await recordTransaction(currentUser.uid, 'convert_winning_to_balance', amt, `Converted Winning Cash to Balance`);

                showStatusMessage(elements.convertWinningCashStatusMessage, 'Conversion successful!', 'success', false);
                setTimeout(() => {
                    if (elements.convertWinningCashModalInstance) elements.convertWinningCashModalInstance.hide();
                }, 2500);
                if (currentSectionId === 'wallet-section') loadRecentTransactions();

            } catch (e) {
                console.error("Convert winning cash error:", e);
                showStatusMessage(elements.convertWinningCashStatusMessage, `Error: ${e.message}`, 'danger');
            } finally {
                elements.submitConvertWinningCashBtn.disabled = false;
                elements.submitConvertWinningCashBtn.innerHTML = 'Convert';
            }
        }


        async function handleMatchDetailsClick(event) {
            console.log("Match Details Clicked");
            if (!elements.matchDetailsModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            const isCustomRoom = event.currentTarget.dataset.isCustomRoom === 'true'; // Check if it's a custom room
            if (!tId) return;

            elements.matchDetailsModalTitle.textContent = 'Loading...'; elements.matchDetailsModalBody.innerHTML = '<div class="tc p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.matchDetailsModalInstance.show();
            try {
                const path = isCustomRoom ? `customRooms/${tId}` : `tournaments/${tId}`; // Adjust path
                const s = await get(ref(db, path));
                if (s.exists()) {
                    const t = s.val();
                    const gName = appSettings.games?.[t.gameId]?.name || t.gameId || 'N/A';
                    const sTimeLoc = t.createdAt ? new Date(t.createdAt).toLocaleString([], { dateStyle: 'short', timeStyle: 'short' }) : 'TBA'; // Use createdAt for custom rooms
                    let pDistHTML = '';
                    if (t.prizeDistribution) {
                        // Try to format nicely, fallback to JSON string
                        let fmtDist = '';
                        if (typeof t.prizeDistribution === 'object') {
                            fmtDist = Object.entries(t.prizeDistribution)
                                .map(([rank, prize]) => `${rank}: Rs${prize}`) // Changed from "Rank X: RsY" to "X: RsY"
                                .join('\n');
                        }
                        else {
                            fmtDist = String(t.prizeDistribution).replace(/\\n/g, '\n');
                        }
                        pDistHTML = `<h5>Prize Distribution:</h5><pre>${fmtDist}</pre>`;
                    }
                    const desc = t.description || 'Standard rules apply.';
                    const fmtDesc = desc.replace(/\n/g, '<br>'); // Handle newlines in description
                    elements.matchDetailsModalTitle.textContent = t.name || 'Match Details';
                    elements.matchDetailsModalBody.innerHTML = `<p><strong>Game:</strong> ${gName}</p><p><strong>Mode:</strong> ${t.mode || 'N/A'}</p><p><strong>Map:</strong> ${t.map || 'N/A'}</p><p><strong>Created At:</strong> ${sTimeLoc}</p><hr><p><strong>Entry:</strong> Rs${t.entryFee}</p><p><strong>Prize:</strong> Rs${t.prizePool || 0}</p><p><strong>Per Kill:</strong> Rs${t.perKillPrize || 0}</p><p><strong>Max Players:</strong> ${t.maxPlayers > 0 ? t.maxPlayers : 'Unlimited'}</p><hr><h5>Rules:</h5><div style="white-space: pre-wrap; line-height: 1.6;">${fmtDesc}</div>${pDistHTML}`;
                } else elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Details not found.</p>';
            } catch (e) { console.error("Details load failed:", e); elements.matchDetailsModalBody.innerHTML = '<p class="text-danger">Error loading details.</p>'; }
        }

        async function handleIdPasswordClick(event) {
            if (!elements.idPasswordModalInstance) return;
            const tId = event.currentTarget.dataset.tournamentId;
            const isCustomRoom = event.currentTarget.dataset.isCustomRoom === 'true'; // Check if it's a custom room
            if (!tId) return;

            console.log("--- Checking ID/Pass ---");
            console.log("Tournament ID (tId):", tId);
            console.log("Is Custom Room:", isCustomRoom);
            console.log("Current User UID:", currentUser?.uid);

            elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>';
            elements.idPasswordModalInstance.show();
            try {
                const path = isCustomRoom ? `customRooms/${tId}` : `tournaments/${tId}`; // Adjust path
                console.log("Fetching from path:", path);
                const s = await get(ref(db, path));
                console.log("Snapshot exists?", s.exists(), "Snapshot value:", s.val());

                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));

                if (s.exists()) {
                    const data = s.val();
                    // For custom rooms, check if creator or if ID/Pass is available
                    if (isCustomRoom) {
                        if (data.creatorUid === currentUser?.uid) {
                            // Creator can always see their own room's ID/Pass
                            elements.roomIdDisplay.textContent = data.roomId || 'Not set yet';
                            elements.roomPasswordDisplay.textContent = data.roomPassword || 'Not set yet';
                            if (!data.roomId || !data.roomPassword) {
                                showStatusMessage(elements.idPasswordModalInstance.querySelector('.modal-body'), 'Room ID/Password not set. Please set them via "Edit Room" option.', 'warning', false);
                            }
                        } else if (userProfile?.joinedTournaments?.[tId]) {
                            // Joined players can see ID/Pass if it's available and within 5 mins of creation time
                            const createdAtTime = data.createdAt || 0;
                            if (data.roomId && data.roomPassword && Date.now() > createdAtTime - (5 * 60 * 1000)) { // 5 minutes before creation time
                                elements.roomIdDisplay.textContent = data.roomId;
                                elements.roomPasswordDisplay.textContent = data.roomPassword;
                            } else {
                                elements.roomIdDisplay.textContent = 'Not available yet';
                                elements.roomPasswordDisplay.textContent = 'Not available yet';
                                showStatusMessage(elements.idPasswordModalInstance.querySelector('.modal-body'), 'Room ID/Password will be available 5 minutes before room creation time.', 'info', false);
                            }
                        } else {
                            // Not creator and not joined
                            elements.roomIdDisplay.textContent = 'N/A';
                            elements.roomPasswordDisplay.textContent = 'N/A';
                            showStatusMessage(elements.idPasswordModalInstance.querySelector('.modal-body'), 'You must join this room to view ID/Password.', 'warning', false);
                        }
                    } else {
                        // For regular tournaments, check showIdPass flag and if user has joined
                        if (data.showIdPass && userProfile?.joinedTournaments?.[tId]) {
                            elements.roomIdDisplay.textContent = data.roomId || 'Not updated yet';
                            elements.roomPasswordDisplay.textContent = data.roomPassword || 'Not updated yet';
                        } else {
                            elements.roomIdDisplay.textContent = 'Hidden by Admin';
                            elements.roomPasswordDisplay.textContent = 'Hidden by Admin';
                        }
                    }
                } else {
                    elements.roomIdDisplay.textContent = 'Not Found'; // Room/Tournament doesn't exist
                    elements.roomPasswordDisplay.textContent = 'Not Found';
                }
            } catch (e) {
                console.error("ID/Pass fetch error:", e);
                removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow'));
                removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow'));
                elements.roomIdDisplay.textContent = 'Error';
                elements.roomPasswordDisplay.textContent = 'Error';
                alert("Error loading ID/Password. Check permissions or network.");
            }
        }

        async function handlePolicyClick(event) {
            console.log("Policy link clicked");
            if (!elements.policyModalInstance) { console.error("Policy modal instance not found"); return; }
            event.preventDefault();
            const target = event.currentTarget;
            const policyType = target.dataset.policy;
            console.log("Policy type requested:", policyType);
            if (!policyType) return;

            let title = '', contentRefPath = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>';
            elements.policyModalBody.innerHTML = modalBodyContent;

            // Use settings data for policies (adjust path based on your settings structure if needed)
            switch (policyType) {
                case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break;
                case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break;
                case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break;
                case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break;
                case 'refer':
                    title = 'Refer & Earn';
                    if (!currentUser) { alert("Login to view referral."); return; }
                    const refCode = userProfile.referralCode || 'N/A';
                    const refBonus = appSettings?.referralBonus || 0; // Use loaded setting
                    const refDesc = appSettings?.referralDescription || `Get Rs${refBonus} when your friend joins using your code.`; // Use loaded setting
                    modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${refDesc}</p></div>`;
                    break;
                case 'contact': // NEW: Contact Info Policy
                    title = 'Contact Information';
                    // Hardcoding the email address
                    const contactNumber = '9846642239'; // Default number
                    const contactEmail = 'chalisebijay950@gmail.com'; // Hardcoded email
                    const contactText = 'For any queries or support, please reach out to us:';
                    modalBodyContent = `
                        <div class="text-center">
                            <h4>${contactText}</h4>
                            <p class="mt-3">
                                <i class="bi bi-phone-fill me-2"></i> <strong>Phone:</strong> <a href="tel:${contactNumber}">${contactNumber}</a>
                            </p>
                            <p>
                                <i class="bi bi-envelope-fill me-2"></i> <strong>Email:</strong> <a href="mailto:${contactEmail}">${contactEmail}</a>
                            </p>
                            <p class="small text-secondary mt-4">We aim to respond within 24-48 hours.</p>
                        </div>
                    `;
                    break;
                default:
                    title = 'Info';
                    console.warn("Unknown policy:", policyType);
                    modalBodyContent = '<p>Content unavailable.</p>';
            }

            elements.policyModalTitle.textContent = title;
            // Handle simple text content, replace \n with <br>
            if (typeof modalBodyContent === 'string' && policyType !== 'refer' && policyType !== 'contact') { // Exclude 'contact' as well
                elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>');
            } else {
                elements.policyModalBody.innerHTML = modalBodyContent; // For referral/contact HTML or errors
            }
            console.log("Showing policy modal for:", policyType);
            elements.policyModalInstance.show();
        }

        // --- Edit Profile Functions ---
        function handleEditProfileClick() {
            if (!currentUser || !elements.editProfileModalInstance) return;
            elements.editDisplayNameInput.value = userProfile.displayName || '';
            clearStatusMessage(elements.editProfileStatusMessage);
            elements.editProfileModalInstance.show();
        }

        async function saveProfileChanges() {
            if (!currentUser) return;
            const newDisplayName = elements.editDisplayNameInput.value.trim();

            if (!newDisplayName) {
                showStatusMessage(elements.editProfileStatusMessage, 'Username cannot be empty.', 'warning');
                return;
            }

            if (newDisplayName === userProfile.displayName) {
                showStatusMessage(elements.editProfileStatusMessage, 'No changes detected.', 'info');
                return;
            }

            elements.saveProfileChangesBtn.disabled = true;
            elements.saveProfileChangesBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            clearStatusMessage(elements.editProfileStatusMessage);

            try {
                // Update Firebase Authentication profile
                await updateProfile(currentUser, { displayName: newDisplayName });

                // Update Realtime Database profile
                const userRef = ref(db, `users/${currentUser.uid}`);
                await update(userRef, { displayName: newDisplayName });

                showStatusMessage(elements.editProfileStatusMessage, 'Profile updated successfully!', 'success');
                // Re-fetch user profile to update UI immediately
                const updatedSnapshot = await get(userRef);
                if (updatedSnapshot.exists()) {
                    userProfile = updatedSnapshot.val();
                    populateUserInfo(currentUser, userProfile);
                }
                setTimeout(() => {
                    elements.editProfileModalInstance.hide();
                }, 1500);

            } catch (e) {
                console.error("Error updating profile:", e);
                showStatusMessage(elements.editProfileStatusMessage, `Failed to update profile: ${e.message}`, 'danger');
            } finally {
                elements.saveProfileChangesBtn.disabled = false;
                elements.saveProfileChangesBtn.innerHTML = 'Save Changes';
            }
        }

        // NEW: Handle Create Room Click
        function handleCreateRoomClick() {
            if (!currentUser) {
                alert("Login to create a room.");
                showSection('login-section');
                return;
            }
            // Pre-fill game selection if only one game is available or a default is set
            if (Object.keys(appSettings.games || {}).length === 1) {
                elements.roomGameIdInput.value = Object.keys(appSettings.games)[0];
            } else {
                elements.roomGameIdInput.value = ''; // Reset selection
            }

            elements.createRoomForm.reset();
            clearStatusMessage(elements.createRoomStatusMessage);
            elements.roomEntryFeeInput.value = DEFAULT_ENTRY_FEE; // Set fixed entry fee
            elements.createRoomModalInstance.show();
            updateRoomDefaults(); // Call to set initial values based on defaults
        }

        // NEW: Function to update room creation defaults based on game, mode, and map
        function updateRoomDefaults() {
            const gameId = elements.roomGameIdInput.value;
            const mode = elements.roomModeInput.value.trim().toLowerCase();
            const map = elements.roomMapInput.value.trim().toLowerCase();

            const entryFee = DEFAULT_ENTRY_FEE; // Fixed entry fee
            const prizePool = CUSTOM_ROOM_PRIZE_POOL; // Fixed prize pool
            let maxPlayers = parseInt(elements.roomMaxPlayersInput.value) || 0; // User-editable
            let description = '';

            // Set default max players if not already set by user or invalid
            if (maxPlayers <= 0) {
                maxPlayers = 50; // Default to 50 if user hasn't set or it's invalid
            }

            // Logic for Free Fire (assuming gameId for Free Fire is 'freefire')
            if (gameId === 'freefire') { // Replace 'freefire' with your actual Free Fire gameId
                if (mode === '1v1') {
                    description = "1v1 match. Only the winner gets the prize.";
                } else if (mode === '2v2') {
                    description = "2v2 match. Prize for the winning duo.";
                } else if (mode === '4v4') {
                    description = "4v4 match. Prize for the winning squad.";
                } else {
                    description = `Custom match on ${map.charAt(0).toUpperCase() + map.slice(1) || 'selected map'}.`;
                }
            } else {
                // Default for other games or if gameId is not 'freefire'
                description = `Custom match for ${appSettings.games?.[gameId]?.name || 'selected game'}.`;
            }

            // Update the input fields (display only)
            elements.roomEntryFeeInput.value = entryFee;
            elements.roomPrizePoolInput.value = prizePool;
            elements.roomMaxPlayersInput.value = maxPlayers; // Keep user's input or default
            elements.roomDescriptionInput.value = description;

            // Store actual values in data attributes for submission
            elements.roomPrizePoolInput.dataset.prizePool = prizePool;
            elements.roomMaxPlayersInput.dataset.maxPlayers = maxPlayers;


            // Store prize distribution as a stringified JSON in a data attribute
            // For fixed winning amounts, prizeDistribution will just be Rank 1
            let prizeDistribution = {};
            if (prizePool > 0) {
                prizeDistribution = { "Rank 1": prizePool };
            }
            elements.roomPrizePoolInput.dataset.prizeDistribution = JSON.stringify(prizeDistribution);

            // Show/hide leader-only message for 4v4 (if applicable, based on your previous logic)
            const leaderOnlyMessage = document.getElementById('leaderOnlyMessage');
            if (mode === '4v4' && maxPlayers === 8) { // Assuming 8 players for 4v4 (2 teams of 4)
                if (!leaderOnlyMessage) {
                    const p = document.createElement('p');
                    p.id = 'leaderOnlyMessage';
                    p.className = 'small text-warning mt-2';
                    p.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> For 4v4, only the squad leader can create and join this room. Max players set to 8 (for 2 teams).';
                    elements.roomMaxPlayersInput.parentNode.appendChild(p);
                }
            } else {
                if (leaderOnlyMessage) {
                    leaderOnlyMessage.remove();
                }
            }
        }


        // NEW: Submit Create Room Request
        async function submitCreateRoomRequest() {
            if (!currentUser) return;

            const roomGameId = elements.roomGameIdInput.value;
            const roomName = elements.roomNameInput.value.trim();
            // Read from input values, prize pool is fixed
            const roomEntryFee = parseFloat(elements.roomEntryFeeInput.value); // This is fixed at DEFAULT_ENTRY_FEE
            const roomPrizePool = CUSTOM_ROOM_PRIZE_POOL; // Fixed prize pool
            const roomMaxPlayers = parseInt(elements.roomMaxPlayersInput.value); // User-editable
            const roomMode = elements.roomModeInput.value.trim();
            const roomMap = elements.roomMapInput.value.trim();
            const roomDescription = elements.roomDescriptionInput.value.trim();
            const prizeDistribution = { "Rank 1": CUSTOM_ROOM_PRIZE_POOL }; // Fixed prize distribution


            const creationFee = appSettings.roomCreationFee || ROOM_CREATION_FEE; // Use updated constant
            const maxRooms = appSettings.maxCustomRooms || MAX_CUSTOM_ROOMS;

            clearStatusMessage(elements.createRoomStatusMessage);

            if (!roomGameId || !roomName || isNaN(roomMaxPlayers) || roomMaxPlayers <= 0) {
                showStatusMessage(elements.createRoomStatusMessage, 'Please fill all required fields and ensure Max Players is a positive number.', 'warning');
                return;
            }
            if (Object.keys(userProfile.customRooms || {}).length >= maxRooms) {
                showStatusMessage(elements.createRoomStatusMessage, `You have reached the maximum limit of ${maxRooms} custom rooms.`, 'danger');
                return;
            }
            if (userProfile.balance < creationFee) {
                showStatusMessage(elements.createRoomStatusMessage, `Insufficient balance. Room creation costs Rs${creationFee}.`, 'danger');
                return;
            }

            elements.submitCreateRoomBtn.disabled = true;
            elements.submitCreateRoomBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

            try {
                // Deduct room creation fee and add room to user's profile via transaction
                const userRef = ref(db, `users/${currentUser.uid}`);
                let newRoomKey = null;

                const transactionResult = await runTransaction(userRef, (currentProfile) => {
                    if (currentProfile) {
                        if ((currentProfile.balance || 0) < creationFee) {
                            throw new Error("Insufficient balance for room creation.");
                        }
                        if (Object.keys(currentProfile.customRooms || {}).length >= maxRooms) {
                            throw new Error(`You have reached the maximum limit of ${maxRooms} custom rooms.`);
                        }

                        currentProfile.balance = (currentProfile.balance || 0) - creationFee;
                        if (!currentProfile.customRooms) {
                            currentProfile.customRooms = {};
                        }
                        // Generate a new key for the room
                        newRoomKey = push(ref(db, 'customRooms')).key; // Get a new unique key
                        currentProfile.customRooms[newRoomKey] = true; // Store reference in user's profile
                    }
                    return currentProfile;
                });

                if (!transactionResult.committed) {
                    throw new Error("Failed to deduct fee or add room to profile.");
                }

                // Create the new custom room entry in the 'customRooms' node
                const newRoomData = {
                    name: roomName,
                    gameId: roomGameId,
                    entryFee: roomEntryFee, // Use constant entry fee (this is total collected)
                    prizePool: roomPrizePool, // Fixed prize pool
                    perKillPrize: 0, // Always 0
                    maxPlayers: roomMaxPlayers, // User-defined max players
                    mode: roomMode,
                    map: roomMap,
                    description: roomDescription,
                    roomId: null, // Room ID will be set later
                    roomPassword: null, // Room Password will be set later
                    creatorUid: currentUser.uid,
                    creatorName: userProfile.displayName || currentUser.email,
                    createdAt: serverTimestamp(),
                    status: 'upcoming', // Default status for user-created rooms
                    showIdPass: true, // User-created rooms always show ID/Pass to creator
                    registeredPlayers: {}, // Initialize empty registered players
                    prizeDistribution: prizeDistribution // Fixed prize distribution
                    // Removed: roomDuration: CUSTOM_ROOM_DURATION_MINUTES, // New: Room duration in minutes
                    // Removed: roomStartTime: null // New: To be set when room starts
                };

                await set(ref(db, `customRooms/${newRoomKey}`), newRoomData);

                // Record transaction for room creation
                await recordTransaction(currentUser.uid, 'room_creation', -creationFee, `Created Custom Room: ${roomName}`, { roomId: newRoomKey });

                showStatusMessage(elements.createRoomStatusMessage, 'Room created successfully! You can set Room ID/Password later via "Edit Room".', 'success', false);
                elements.createRoomForm.reset();
                setTimeout(() => {
                    elements.createRoomModalInstance.hide();
                }, 2500);
                loadMyCustomRooms(); // Refresh the list of custom rooms

                // Removed: NEW: Schedule room deletion and monitor players
                // Removed: scheduleRoomDeletion(newRoomKey, newRoomData.createdAt, newRoomData.roomDuration);
                // Removed: monitorRoomPlayersAndStartTime(newRoomKey, newRoomData.createdAt, roomEntryFee);

            } catch (e) {
                console.error("Error creating room:", e);
                showStatusMessage(elements.createRoomStatusMessage, `Failed to create room: ${e.message}`, 'danger');
            } finally {
                elements.submitCreateRoomBtn.disabled = false;
                elements.submitCreateRoomBtn.innerHTML = 'Create Room';
            }
        }

        // Removed: NEW: Function to schedule room deletion after its duration
        // function scheduleRoomDeletion(roomId, createdAt, durationMinutes) {
        //     const roomRef = ref(db, `customRooms/${roomId}`);
        //     const deletionTime = createdAt + (durationMinutes * 60 * 1000); // Calculate deletion timestamp

        //     console.log(`Scheduling deletion for room ${roomId} at ${new Date(deletionTime).toLocaleString()}`);

        //     // Set a listener that triggers deletion if the room still exists after the duration
        //     // This is a client-side timer, for robust solutions, a server-side function (e.g., Firebase Cloud Function) is better.
        //     const timerId = setTimeout(async () => {
        //         try {
        //             const snapshot = await get(roomRef);
        //             if (snapshot.exists()) {
        //                 const roomData = snapshot.val();
        //                 // Only delete if the room hasn't been marked as started or completed
        //                 if (!roomData.roomStarted && roomData.status !== 'completed') {
        //                     console.log(`Room ${roomId} duration ended. Deleting...`);
        //                     await deleteCustomRoom(roomId, roomData.registeredPlayers, roomData.entryFee, "Room duration ended.");
        //                 } else {
        //                     console.log(`Room ${roomId} has started or completed, not deleting by duration.`);
        //                 }
        //             } else {
        //                 console.log(`Room ${roomId} already deleted.`);
        //             }
        //         } catch (error) {
        //             console.error(`Error during scheduled deletion for room ${roomId}:`, error);
        //         }
        //     }, deletionTime - Date.now());

        //     // Store the timer ID if needed for cancellation (e.g., if room starts early)
        //     // For simplicity, not storing it in dbListeners here, but could be added.
        // }

        // Removed: NEW: Function to monitor custom room players and start time
        // function monitorRoomPlayersAndStartTime(roomId, createdAt, entryFee) {
        //     const roomRef = ref(db, `customRooms/${roomId}`);
        //     let playerMonitorListener = null;
        //     let startTimeMonitorListener = null;
        //     let playerCheckTimeout = null;
        //     let startTimeCheckTimeout = null;

        //     // Listener for player count
        //     playerMonitorListener = onValue(ref(db, `customRooms/${roomId}/registeredPlayers`), (snapshot) => {
        //         const registeredPlayers = snapshot.val() || {};
        //         const playerCount = Object.keys(registeredPlayers).length;
        //         console.log(`Room ${roomId}: Player count updated to ${playerCount}`);

        //         // Clear any existing timeouts to prevent multiple triggers
        //         if (playerCheckTimeout) clearTimeout(playerCheckTimeout);
        //         if (startTimeCheckTimeout) clearTimeout(startTimeCheckTimeout);

        //         if (playerCount < MIN_PLAYERS_FOR_CUSTOM_ROOM) {
        //             // If players are less than minimum, schedule deletion after room duration
        //             // This covers cases where players drop below 10 after initially reaching it
        //             playerCheckTimeout = setTimeout(async () => {
        //                 const currentRoomSnapshot = await get(roomRef);
        //                 if (currentRoomSnapshot.exists()) {
        //                     const currentRoomData = currentRoomSnapshot.val();
        //                     const currentPlayers = Object.keys(currentRoomData.registeredPlayers || {}).length;
        //                     if (currentPlayers < MIN_PLAYERS_FOR_CUSTOM_ROOM && !currentRoomData.roomStarted && currentRoomData.status !== 'completed') {
        //                         console.log(`Room ${roomId} duration ended. Deleting...`);
        //                         await deleteCustomRoom(roomId, currentRoomData.registeredPlayers, roomData.entryFee, `Less than ${MIN_PLAYERS_FOR_CUSTOM_ROOM} players.`);
        //                     }
        //                 }
        //             }, CUSTOM_ROOM_DURATION_MINUTES * 60 * 1000 - (Date.now() - createdAt)); // Time remaining until room duration ends
        //         } else {
        //             // If player count reaches minimum, set a timer for room start
        //             // This assumes the room creator will update `roomStartTime` when the match actually begins.
        //             startTimeCheckTimeout = setTimeout(async () => {
        //                 const currentRoomSnapshot = await get(roomRef);
        //                 if (currentRoomSnapshot.exists()) {
        //                     const currentRoomData = currentRoomSnapshot.val();
        //                     if (!currentRoomData.roomStarted && currentRoomData.status !== 'completed') {
        //                         console.log(`Room ${roomId}: Reached ${MIN_PLAYERS_FOR_CUSTOM_ROOM} players but not started within ${CUSTOM_ROOM_START_GRACE_PERIOD_MINUTES} minutes. Deleting...`);
        //                         await deleteCustomRoom(roomId, currentRoomData.registeredPlayers, roomData.entryFee, `Did not start within ${CUSTOM_ROOM_START_GRACE_PERIOD_MINUTES} minutes.`);
        //                     }
        //                 }
        //             }, CUSTOM_ROOM_START_GRACE_PERIOD_MINUTES * 60 * 1000); // 30 minutes grace period
        //         }
        //     });

        //     // Store listeners to detach later if needed (e.g., if room is manually deleted or starts)
        //     dbListeners[`roomPlayers_${roomId}`] = { path: `customRooms/${roomId}/registeredPlayers`, func: playerMonitorListener };
        //     // dbListeners[`roomStartTime_${roomId}`] = { path: `customRooms/${roomId}/roomStartTime`, func: startTimeMonitorListener }; // Not strictly needed if we rely on the timeout
        // }

        // NEW: Function to delete a custom room and refund players and creator
        async function deleteCustomRoom(roomId, registeredPlayers, entryFee, reason) {
            console.log(`Attempting to delete room ${roomId} due to: ${reason}`);
            const roomRef = ref(db, `customRooms/${roomId}`);
            const updates = {};

            try {
                const roomSnapshot = await get(roomRef);
                if (!roomSnapshot.exists()) {
                    console.log(`Room ${roomId} already deleted or does not exist.`);
                    return;
                }
                const roomData = roomSnapshot.val();
                const creatorUid = roomData.creatorUid;
                const creationFee = appSettings.roomCreationFee || ROOM_CREATION_FEE; // Get creation fee from settings or default

                // Refund players
                if (registeredPlayers && Object.keys(registeredPlayers).length > 0 && entryFee > 0) {
                    console.log(`Refunding ${Object.keys(registeredPlayers).length} players for room ${roomId}`);
                    for (const playerId in registeredPlayers) {
                        const playerRef = ref(db, `users/${playerId}`);
                        await runTransaction(playerRef, (profile) => {
                            if (profile) {
                                profile.balance = (profile.balance || 0) + entryFee;
                                // Also remove from joinedTournaments if it was a custom room they joined
                                if (profile.joinedTournaments && profile.joinedTournaments[roomId]) {
                                    delete profile.joinedTournaments[roomId];
                                    if (Object.keys(profile.joinedTournaments).length === 0) {
                                        profile.joinedTournaments = null; // Clean up if empty
                                    }
                                }
                            }
                            return profile;
                        });
                        await recordTransaction(playerId, 'room_refund', entryFee, `Refund for Custom Room: ${roomData.name} (Entry Fee) - ${reason}`);
                    }
                }

                // Refund creator
                if (creatorUid) {
                    console.log(`Refunding creator ${creatorUid} for room ${roomId}`);
                    const creatorRef = ref(db, `users/${creatorUid}`);
                    await runTransaction(creatorRef, (profile) => {
                        if (profile) {
                            profile.balance = (profile.balance || 0) + creationFee;
                        }
                        return profile;
                    });
                    await recordTransaction(creatorUid, 'room_creation_refund', creationFee, `Refund for Custom Room: ${roomData.name} (Creation Fee) - ${reason}`);
                }

                // Remove room from creator's customRooms list
                if (creatorUid) {
                    updates[`users/${creatorUid}/customRooms/${roomId}`] = null;
                }

                // Delete the room itself
                updates[`customRooms/${roomId}`] = null;

                await update(ref(db), updates);
                console.log(`Successfully deleted room ${roomId} and processed refunds.`);
                // alert(`Custom room "${roomData.name}" was deleted. Reason: ${reason}. Funds refunded to players and creator.`); // This alert might be annoying for admin
                // Consider a more subtle notification for the user if they are the creator
                if (currentUser && currentUser.uid === creatorUid) {
                    showStatusMessage(elements.inAppNotificationBanner, `Your custom room "${roomData.name}" was deleted. Creation fee refunded.`, 'info', true);
                }

                // Detach listeners for this room (if any were active, though auto-deletion is removed)
                if (dbListeners[`roomPlayers_${roomId}`]) {
                    off(ref(db, dbListeners[`roomPlayers_${roomId}`].path), 'value', dbListeners[`roomPlayers_${roomId}`].func);
                    delete dbListeners[`roomPlayers_${roomId}`];
                }
                // Refresh relevant sections
                if (currentSectionId === 'make-room-section') loadMyCustomRooms();
                if (currentSectionId === 'tournaments-section' && currentTournamentGameId) {
                    const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                    const activeType = querySel('.tournament-tabs .tab-item.active')?.dataset.type || 'regular';
                    filterTournaments(currentTournamentGameId, activeTab, activeType);
                }
                if (currentSectionId === 'wallet-section') loadRecentTransactions();

            } catch (error) {
                console.error(`Error deleting room ${roomId} or refunding players/creator:`, error);
                // alert(`Failed to delete custom room "${roomId}" or refund players/creator. Please contact support. Error: ${error.message}`);
                showStatusMessage(elements.inAppNotificationBanner, `Failed to delete custom room "${roomId}". Error: ${error.message}`, 'danger', true);
            }
        }

        // New: Handle Delete Room Click
        async function handleDeleteRoomClick(event) {
            const tId = event.currentTarget.dataset.tournamentId;
            if (!tId) return;

            if (!confirm("Are you sure you want to delete this custom room? This action cannot be undone and will refund players.")) {
                return;
            }

            showLoader(true);
            try {
                const roomRef = ref(db, `customRooms/${tId}`);
                const roomSnapshot = await get(roomRef);
                if (!roomSnapshot.exists()) {
                    alert("Room not found or already deleted.");
                    return;
                }
                const roomData = roomSnapshot.val();

                if (roomData.creatorUid !== currentUser.uid) {
                    alert("You are not authorized to delete this room.");
                    return;
                }

                await deleteCustomRoom(tId, roomData.registeredPlayers, roomData.entryFee, "Creator deleted room.");
                alert("Custom room deleted successfully and funds refunded.");

            } catch (e) {
                console.error("Error deleting custom room:", e);
                alert(`Failed to delete room: ${e.message}`);
            } finally {
                showLoader(false);
            }
        }

        // NEW: Handle Edit Room Click
        async function handleEditRoomClick(event) {
            if (!currentUser || !elements.editRoomModalInstance) return;
            const roomId = event.currentTarget.dataset.tournamentId;
            if (!roomId) return;

            elements.editRoomIdHiddenEl.value = roomId;
            clearStatusMessage(elements.editRoomStatusMessage);
            elements.editRoomIDInput.value = '';
            elements.editRoomPasswordInput.value = '';

            showLoader(true);
            try {
                const roomRef = ref(db, `customRooms/${roomId}`);
                const snapshot = await get(roomRef);
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    if (roomData.creatorUid !== currentUser.uid) {
                        alert("You are not authorized to edit this room.");
                        elements.editRoomModalInstance.hide();
                        return;
                    }
                    elements.editRoomIDInput.value = roomData.roomId || '';
                    elements.editRoomPasswordInput.value = roomData.roomPassword || '';
                    elements.editRoomModalInstance.show();
                } else {
                    alert("Room not found.");
                }
            } catch (e) {
                console.error("Error fetching room details for edit:", e);
                alert("Error loading room details.");
            } finally {
                showLoader(false);
            }
        }

        // NEW: Submit Edit Room Changes
        async function submitEditRoomChanges() {
            if (!currentUser) return;
            const roomId = elements.editRoomIdHiddenEl.value;
            const newRoomId = elements.editRoomIDInput.value.trim();
            const newRoomPassword = elements.editRoomPasswordInput.value.trim();

            if (!roomId || !newRoomId || !newRoomPassword) {
                showStatusMessage(elements.editRoomStatusMessage, 'Room ID and Password cannot be empty.', 'warning');
                return;
            }

            elements.submitEditRoomBtn.disabled = true;
            elements.submitEditRoomBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            clearStatusMessage(elements.editRoomStatusMessage);

            try {
                const roomRef = ref(db, `customRooms/${roomId}`);
                const snapshot = await get(roomRef);
                if (!snapshot.exists() || snapshot.val().creatorUid !== currentUser.uid) {
                    throw new Error("Unauthorized or room not found.");
                }

                await update(roomRef, {
                    roomId: newRoomId,
                    roomPassword: newRoomPassword
                });

                showStatusMessage(elements.editRoomStatusMessage, 'Room ID and Password updated successfully!', 'success');
                setTimeout(() => {
                    elements.editRoomModalInstance.hide();
                }, 1500);
                loadMyCustomRooms(); // Refresh the list to reflect changes
            } catch (e) {
                console.error("Error updating room details:", e);
                showStatusMessage(elements.editRoomStatusMessage, `Failed to update room: ${e.message}`, 'danger');
            } finally {
                elements.submitEditRoomBtn.disabled = false;
                elements.submitEditRoomBtn.innerHTML = 'Save Changes';
            }
        }


        // --- Realtime Listeners Setup ---
        function setupRealtimeListeners(uid) {
            if (!uid || !db || !currentUser) return;
            detachAllDbListeners(); // Ensure no duplicates
            console.log("Setting up realtime listener for User Profile:", uid);
            const uRef = ref(db, `users/${uid}`);
            const listFunc = onValue(uRef, (s) => {
                if (currentUser && currentUser.uid === uid) { // Check if user is still the logged-in one
                    if (s.exists()) {
                        console.log("Realtime: User Profile Update Received");
                        userProfile = s.val();
                        populateUserInfo(currentUser, userProfile); // Update UI with latest data
                        // Refresh sections that depend on profile changes (like My Contests, My Custom Rooms)
                        if (currentSectionId === 'home-section') loadMyContests();
                        if (currentSectionId === 'wallet-section') loadRecentTransactions(); // Balance might change
                        if (currentSectionId === 'make-room-section') loadMyCustomRooms(); // Refresh custom rooms
                    } else {
                        console.warn("User data deleted (realtime) for:", uid);
                        alert("Account data missing or deleted. Logging out.");
                        logoutUser();
                    }
                } else {
                    console.log("Realtime listener fired for a different user or logged-out state. Detaching.");
                    off(uRef, 'value', listFunc); // Detach listener if user changed
                }
            }, (e) => {
                console.error("Listener error (user profile):", e);
                // Optionally try to re-attach or show error
            });
            dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc };

            // Setup listener for in-app notifications
            setupInAppNotificationListener();
        }

        function detachAllDbListeners() {
            console.log("Detaching listeners:", Object.keys(dbListeners));
            let count = 0;
            for (const k in dbListeners) {
                try {
                    const { path, func } = dbListeners[k];
                    if (path && func) {
                        off(ref(db, path), 'value', func);
                        count++;
                    } else {
                        console.warn(`Listener object invalid for key: ${k}`);
                    }
                } catch (e) { console.error(`Detach error ${k}:`, e); }
            }
            dbListeners = {};
            console.log(`Detached ${count} listeners.`);
        }

        // --- In-App Notification Functions ---
        function setupInAppNotificationListener() {
            console.log("Setting up in-app notification listener...");
            const notificationsRef = ref(db, 'notifications');

            // Detach any previous listener to avoid duplicates
            if (dbListeners['notifications']) {
                off(notificationsRef, 'value', dbListeners['notifications'].func);
                delete dbListeners['notifications'];
            }

            const notificationListener = onValue(notificationsRef, (snapshot) => {
                if (snapshot.exists()) {
                    const notifications = snapshot.val();
                    // Assuming notifications are stored as an object, get the latest one
                    const latestNotificationKey = Object.keys(notifications).sort().pop();
                    const latestNotification = notifications[latestNotificationKey];

                    if (latestNotification && latestNotification.message && latestNotification.active) {
                        displayInAppNotification(latestNotification.message, latestNotification.type || 'info');
                    } else {
                        hideInAppNotification();
                    }
                } else {
                    hideInAppNotification();
                }
            }, (error) => {
                console.error("In-app notification listener failed:", error);
                hideInAppNotification();
            });

            dbListeners['notifications'] = { path: 'notifications', func: notificationListener };
        }

        function displayInAppNotification(message, type = 'info') {
            if (elements.inAppNotificationBanner && elements.notificationMessage) {
                elements.notificationMessage.textContent = message;
                elements.inAppNotificationBanner.className = `in-app-notification-banner ${type}`; // Apply type class
                elements.inAppNotificationBanner.style.display = 'block';
            }
        }

        function hideInAppNotification() {
            if (elements.inAppNotificationBanner) {
                elements.inAppNotificationBanner.style.display = 'none';
            }
        }

        // --- NEW: Time and Greeting Function ---
        function updateNepalTimeAndGreeting() {
            if (!elements.headerTimeGreeting) return;

            // Use a reliable API for time in Nepal (Kathmandu timezone)
            // You might need to use a server-side function or a more robust client-side library
            // for accurate timezone handling without relying on external APIs for every update.
            // For this example, we'll use a simple approach with Intl.DateTimeFormat.
            const now = new Date();
            const options = {
                timeZone: 'Asia/Kathmandu',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true // 12-hour format with AM/PM
            };
            const nepalTime = new Intl.DateTimeFormat('en-US', options).format(now);

            // Get the hour in Nepal time for greeting
            const nepalHour = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Kathmandu' })).getHours();

            let greeting = '';
            if (nepalHour >= 5 && nepalHour < 12) {
                greeting = 'Good Morning';
            } else if (nepalHour >= 12 && nepalHour < 17) {
                greeting = 'Good Afternoon';
            } else {
                greeting = 'Good Evening';
            }

            elements.headerTimeGreeting.textContent = `${greeting}, ${nepalTime}`;
        }


        // --- Security Rules Check ---
        async function checkSecurityRules() {
            console.log("Checking security rules...");
            try {
                // Attempt to read root only if NOT logged in (to check public read)
                if (!currentUser) {
                    // If loadAppSettings failed with permission error, rules are likely secure.
                    // If loadAppSettings worked, *potentially* insecure, but maybe settings are public?
                    // A better check involves trying to write to an unauthorized location.
                    // For simplicity, we'll rely on the warning if settings load works anonymously.
                    // This check is imperfect. Best practice is to review rules in Firebase console.
                    console.log("Security rule check skipped for anonymous user (rely on console).");

                } else if (elements.securityWarning) {
                    // Hide warning if user is logged in (assuming rules are user-based)
                    elements.securityWarning.style.display = 'none';
                }
                // Consider attempting an unauthorized write operation here for a more robust check
                // e.g., try { await set(ref(db, `unauthorizedWriteTest/${Date.now()}`), true); /* If success => insecure */ } catch(e) { /* If permission denied => secure */ }
            } catch (error) {
                // Catch specific permission errors if the check above changes
                console.log("Security rule check result (expected failure if secure):", error.message);
                if (elements.securityWarning) elements.securityWarning.style.display = 'none';
            }
        }

        // NEW: Function to show specific payment method details
        function showPaymentMethodDetails(method) {
            elements.paymentMethodDetails.forEach(detailDiv => {
                detailDiv.classList.remove('active');
            });
            elements.paymentMethodButtons.forEach(button => {
                button.classList.remove('active');
            });

            const selectedDetails = document.querySelector(`.payment-method-details[data-method="${method}"]`);
            const selectedButton = document.querySelector(`.payment-methods-selector .btn[data-method="${method}"]`);

            if (selectedDetails) {
                selectedDetails.classList.add('active');
            }
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        }


        // --- Event Listeners Initialization ---
        function initializeEventListeners() {
            if (!elements) return; console.log("Initializing listeners...");
            // Bottom Nav
            elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
            // Header Back
            elements.headerBackBtn?.addEventListener('click', () => showSection('home-section'));
            // Tournament Tabs
            elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => {
                const s = e.currentTarget.dataset.status;
                const type = e.currentTarget.dataset.type;
                if (currentTournamentGameId && (s || type === 'custom')) { // Allow custom tab without status
                    elements.tournamentTabs.forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    filterTournaments(currentTournamentGameId, s, type);
                }
            }));

            // Login/Signup Forms
            elements.loginEmailBtn?.addEventListener('click', loginWithEmail);
            elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
            elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false)); // Show Signup
            elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true)); // Show Login
            elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });

            // Profile Actions
            elements.logoutProfileBtn?.addEventListener('click', logoutUser);
            elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick)); // <<< Listener for policies
            elements.notificationSwitch?.addEventListener('change', (e) => { console.log("Notification toggle:", e.target.checked); /* TODO: Implement notification preference saving */ });
            elements.editProfileLink?.addEventListener('click', handleEditProfileClick); // New: Edit Profile Link
            elements.saveProfileChangesBtn?.addEventListener('click', saveProfileChanges); // New: Save Profile Changes Button
            elements.changePasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); }); // New: Change Password Link

            // Wallet Actions
            elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
            elements.addAmountWalletBtn?.addEventListener('click', () => {
                if (currentUser && elements.addAmountModalInstance) {
                    if (elements.modalUserEmail) elements.modalUserEmail.textContent = currentUser.email || 'N/A';
                    elements.addAmountModalInstance.show();
                } else if (!currentUser) {
                    alert("Login first."); showSection('login-section');
                }
            });
            elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
            elements.convertWinningCashBtn?.addEventListener('click', handleConvertWinningCashClick); // New: Convert Winning Cash Button
            elements.submitConvertWinningCashBtn?.addEventListener('click', submitConvertWinningCashRequest); // New: Submit Convert Winning Cash

            // NEW: Add event listeners for payment method buttons
            elements.paymentMethodButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showPaymentMethodDetails(button.dataset.method);
                });
            });

            // NEW: When the add amount modal is shown, default to the first payment method
            if (elements.addAmountModalInstance) {
                elements.addAmountModalInstance._element.addEventListener('show.bs.modal', () => {
                    showPaymentMethodDetails('esewa'); // Default to Esewa when modal opens
                });
            }


            // Other Actions
            elements.notificationBtn?.addEventListener('click', () => alert('Notifications coming soon!'));
            elements.allTransactionsBtn?.addEventListener('click', () => alert('Transaction history page coming soon!'));
            // Removed: elements.viewEarningsHistoryBtn?.addEventListener('click', () => alert('Transaction history page coming soon!'));

            // Delegated Event Listener for Copy/Share buttons
            document.body.addEventListener('click', (event) => {
                // Copy Button
                if (event.target.matches('.copy-btn') || event.target.closest('.copy-btn')) {
                    const btn = event.target.closest('.copy-btn');
                    const targetSelector = btn.dataset.target; // Expects #elementId selector
                    if (targetSelector) {
                        copyToClipboard(targetSelector);
                    } else {
                        console.warn("Copy button missing data-target selector.");
                    }
                }
                // Share Button (in Refer modal)
                if (event.target.matches('#shareReferralBtn') || event.target.closest('#shareReferralBtn')) {
                    const cel = getElement('referralCodeDisplay');
                    if (cel) shareReferral(cel.textContent);
                }
            });

            // New event listener for the game details modal submit button
            elements.submitGameDetailsBtn?.addEventListener('click', submitGameDetailsAndJoin);

            // App Update Modal "Remind Me Later" button
            elements.remindMeLaterBtnEl?.addEventListener('click', () => {
                elements.appUpdateModalInstance.hide();
            });

            // New: Create Room Button and Modal Submit
            elements.createRoomBtn?.addEventListener('click', handleCreateRoomClick);
            elements.submitCreateRoomBtn?.addEventListener('click', submitCreateRoomRequest);

            // Add event listeners for dynamic room creation inputs
            elements.roomGameIdInput?.addEventListener('change', updateRoomDefaults);
            elements.roomModeInput?.addEventListener('input', updateRoomDefaults); // Use 'input' for text fields
            elements.roomMapInput?.addEventListener('input', updateRoomDefaults); // Use 'input' for text fields
            elements.roomMaxPlayersInput?.addEventListener('input', updateRoomDefaults); // Listen for changes in Max Players

            // NEW: Edit Room Modal Listeners
            elements.submitEditRoomBtn?.addEventListener('click', submitEditRoomChanges);

            console.log("Listeners initialized.");
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Init App...");

            // Show loading screen immediately
            if (elements.loadingScreen) {
                elements.loadingScreen.style.display = 'flex';
            }

            // Hide loading screen after 1 second and then proceed with app initialization
            setTimeout(() => {
                if (elements.loadingScreen) {
                    elements.loadingScreen.classList.add('hidden');
                    elements.loadingScreen.addEventListener('transitionend', () => {
                        elements.loadingScreen.style.display = 'none';
                    }, { once: true });
                }

                // Check if Firebase was initialized (handles the case where config was bad)
                if (typeof initializeApp !== 'function' || !auth || !db) {
                    console.error("Firebase SDK failed/not ready. Cannot proceed.");
                    // The error message should already be displayed by the catch block during initialization
                    return;
                }
                showLoader(true);

                // Initialize listeners first
                initializeEventListeners();
                updateGlobalUI(false); // Initial UI state (logged out)

                // Start listening for settings and auth changes
                loadAppSettings(); // This now sets up a realtime listener
                onAuthStateChanged(auth, handleAuthStateChange); // Start listening for auth changes
                // checkSecurityRules(); // Optional check

                // Start updating Nepal time and greeting every second
                updateNepalTimeAndGreeting(); // Initial call
                setInterval(updateNepalTimeAndGreeting, 1000);

            }, 1000); // 1 second delay for loading animation
        });
    </script>


    <!-- Firebase Cloud Messaging Integration -->
    <script type="module">
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";

        // Firebase config (same as your main config)
        const firebaseConfig = {
            apiKey: "AIzaSyCubH9JVbi6B0c0wWLzU96bH0qgTTyhip8",
            authDomain: "free-fire-8c70d.firebaseapp.com",
            databaseURL: "https://free-fire-8c70d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "free-fire-8c70d",
            storageBucket: "free-fire-8c70d.firebasestorage.app",
            messagingSenderId: "1035240874032",
            appId: "1:1035240874032:web:aea112ac90fca42f540df5"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then(reg => console.log("Service Worker registered", reg))
                .catch(err => console.error("SW registration failed", err));
        }

        async function requestNotificationPermission() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    const token = await getToken(messaging, { vapidKey: "YOUR_PUBLIC_VAPID_KEY" });
                    console.log("FCM Token:", token);
                } else {
                    console.warn("Notification permission not granted.");
                }
            } catch (err) {
                console.error("Error getting FCM token", err);
            }
        }
        requestNotificationPermission();

        onMessage(messaging, (payload) => {
            console.log("Foreground message:", payload);
            const banner = document.getElementById("inAppNotificationBanner");
            const msg = document.getElementById("notificationMessage");
            if (banner && msg) {
                msg.innerText = (payload.notification?.title || "Notification") + " - " + (payload.notification?.body || "");
                banner.style.display = "block";
            }
        });
    </script>

</body>

</html>
